# Технические заметки - Hat Web

## Логика переноса времени (обновлено 21.09.2025)

### Проблема
Время игроков накапливалось в `playerCarriedTime` и не очищалось при завершении игры, что приводило к утечке памяти.

### Решение
1. **Очистка при завершении игры**: `playerCarriedTime = {}` в `startNextRound()`
2. **Очистка при начале новой игры**: `playerCarriedTime = {}` в `startGame()`
3. **Клиентская очистка**: `clearCarriedTime()` в localStorage при начале новой игры

### Ключевые функции
- `startGame()` - очищает время при начале новой игры
- `startNextRound()` - очищает время при завершении игры
- `clearCarriedTime()` - очищает localStorage на клиенте

### Архитектура
- **Клиент**: Время хранится в localStorage (`hatGame_carriedTime`)
- **Сервер**: Время хранится в `gameState.playerCarriedTime` (только для совместимости)
- **Очистка**: Автоматическая при завершении игры и начале новой игры

### Логирование
Добавлено логирование очистки времени для отладки:
```javascript
console.log('Перенесенное время очищено при начале новой игры');
console.log('Перенесенное время очищено при завершении игры');
```

## Структура данных

### gameState.playerCarriedTime
```javascript
{
  [playerId]: carriedTimeSeconds
}
```
- Очищается при завершении игры
- Очищается при начале новой игры
- Используется только для совместимости с клиентом

### localStorage
```javascript
// Ключ: 'hatGame_carriedTime'
// Значение: строка с количеством секунд
// Очищается при начале новой игры
```

## Тестирование

### Сценарии для проверки
1. **Завершение игры**: Проверить очистку `playerCarriedTime`
2. **Начало новой игры**: Проверить очистку localStorage и `playerCarriedTime`
3. **Перенос времени**: Проверить корректность переноса между раундами
4. **Утечки памяти**: Проверить отсутствие накопления данных

### Команды для тестирования
```bash
# Запуск сервера
npm start

# Проверка в браузере
# 1. Открыть DevTools → Application → Local Storage
# 2. Начать игру, завершить раунд с остатком времени
# 3. Проверить наличие 'hatGame_carriedTime' в localStorage
# 4. Завершить игру, начать новую
# 5. Проверить очистку localStorage
```

## Совместимость

### Обратная совместимость
- Сохранены все существующие WebSocket события
- Клиентская логика работает независимо от сервера
- Серверная логика остается рабочей для совместимости

### Миграция
Никаких миграций не требуется - изменения обратно совместимы.

## Мониторинг

### Логи для отслеживания
- `Перенесенное время очищено при начале новой игры`
- `Перенесенное время очищено при завершении игры`
- `Сохранено перенесенное время Xс для игрока Y`

### Метрики
- Размер `playerCarriedTime` должен быть 0 после завершения игры
- localStorage не должен содержать `hatGame_carriedTime` после начала новой игры
