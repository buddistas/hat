# История изменений - Hat Web

## [29.09.2025] - Интеграция MongoDB, миграция данных и фикс переноса времени

### Добавлено
- Репозитории для MongoDB: `MongoStatsRepository`, `MongoWordRepository` и фабрика `RepositoryFactory` с fallback на файловую систему.
- Скрипты:
  - `scripts/init_mongodb.js` — создание индексов и проверка статуса БД
  - `scripts/migrate_to_mongodb.js` — миграция словаря, статистики, лидербордов и JSONL событий
- Документация: `MONGODB_SETUP.md` обновлён (Docker 8.0, .env, миграция, FCV совместимость).

### Изменено
- `server.js` переведён на фабрику репозиториев, graceful shutdown закрывает Mongo.
- `GameService`: убрано постоянное сохранение состояния — сохраняем только финал игры.
- `ProjectPlan.md`: уточнено правило переноса времени — минимум 5 секунд на старте 2‑го и 3‑го раундов; добавлены разделы по Docker/миграции.

### Исправлено
- `Game.startNextRound()` — правило минимума 5 секунд теперь применяется для внутренних раундов 1 и 2 (`currentRound === 1 || currentRound === 2`), что соответствует 2‑му и 3‑му раундам по UX. Ранее работало только для 3‑го.

### Скрипты npm
- `init:mongodb`, `migrate:mongodb`, `setup:mongodb`.

### Примечания по совместимости
- Если в volume лежат данные с FCV=8.0 — используйте образ `mongo:8.0`, либо очистите volume для `mongo:7.0`.

## [26.09.2025] - Добавление дополнительных метрик игровой сессии

### Добавлено
- **Новые метрики сессии**:
  - Отслеживание самого часто пропускаемого слова в партии
  - Отслеживание самого сложного слова (на которое потрачено больше всего времени)
  - Продолжительность каждого раунда в секундах
  - Общая продолжительность партии в секундах
- **Новые методы StatsService**:
  - `onWordShown(word)` - фиксация времени показа слова
  - `_updatePassedWordCount()` - обновление счетчика пропусков
  - `_updateWordDisplayTime()` - обновление времени показа слова
  - `_recordRoundDuration(round)` - фиксация продолжительности раунда
  - `_calculateTotalGameDuration()` - расчет общей продолжительности партии
  - `_calculateSessionFacts()` - расчет фактов сессии
- **Расширенные структуры данных**:
  - `sessionStats.wordTracking.passedWords` - счетчик пропусков по словам
  - `sessionStats.wordTracking.wordDisplayTime` - суммарное время показа слова
  - `sessionStats.duration.roundDurations` - продолжительность раундов
  - `sessionStats.duration.totalGameDuration` - общая продолжительность партии
  - `sessionStats.facts.mostPassedWord` - самое часто пропускаемое слово
  - `sessionStats.facts.hardestWord` - самое сложное слово
- **Интеграция с GameService**:
  - Автоматическое отслеживание показа слов при `next_word`
  - Обработка истечения времени хода с передачей оставшегося времени
- **Подробные тесты**:
  - Unit-тесты для всех новых методов StatsService
  - Интеграционные тесты для проверки работы в реальных сценариях
  - Тесты для граничных случаев (истечение времени, пустые сессии)

### Изменено
- **StatsService.resetSession()**: Добавлена инициализация новых структур данных
- **StatsService.onWordGuessed()**: Добавлено обновление времени показа слова
- **StatsService.onWordPassed()**: Добавлено обновление счетчика пропусков и времени показа
- **StatsService.endTurn()**: Добавлена обработка истечения времени хода
- **StatsService.endSession()**: Добавлен расчет фактов сессии и общей продолжительности
- **GameService.handleNextWord()**: Добавлен вызов `onWordShown` для отслеживания показа слов
- **GameService.handleTimeUp()**: Добавлена передача времени таймера в `endTurn`

### Технические детали
- **Время в секундах**: Все новые метрики времени хранятся в секундах для удобства
- **Активное время**: Учитывается только активное время игры (исключая паузы)
- **Валидация данных**: Добавлена проверка корректности данных при обновлении метрик
- **События в логе**: Добавлены новые типы событий для отслеживания метрик
- **Автоматический сброс**: Все метрики автоматически сбрасываются при старте новой сессии

## [26.09.2025] - Создание скрипта сортировки словаря и расширение до 3185 слов

### Добавлено
- **Новый скрипт сортировки**: `scripts/sort_dictionary.js` - единый скрипт для нормализации, дедупликации и сортировки словаря
- **Функции скрипта**:
  - Нормализация слов (верхний регистр, схлопывание пробелов, нормализация тире и апострофов)
  - Удаление дубликатов по полной записи (слово+категория+уровень)
  - Сортировка по категории, затем по слову (русская колляция)
  - Создание бэкапа перед изменениями
  - Валидация категорий и уровней
  - Подробная статистика

### Изменено
- **Словарь расширен**: Количество слов увеличено до 3185 слов
- **Организация скриптов**: Все скрипты добавления слов перемещены в папку `scripts/add_ing/`
- **Очистка**: Удалены устаревшие скрипты дедупликации и обработки

### Удалено
- `scripts/dedupe_preserve_order.js`
- `scripts/find_and_move_duplicates.js`
- `scripts/find_and_move_duplicates_fixed.js`
- `scripts/preview_high_freq_85.js`
- `scripts/remove_duplicates.js`
- `scripts/check_duplicates.out.txt`
- `public/words_processed.csv`

### Технические детали
- **Файлы**: `scripts/sort_dictionary.js`, `public/words.csv`, `public/dictionary_statistics.md`
- **Правила сортировки**: Сначала по категории (алфавит ru, sensitivity=base), затем по слову
- **Нормализация**: Верхний регистр, нормализация тире (– — − → -) и апострофов (' ` ´ → ')
- **Дедупликация**: Удаление точных дублей записей (слово+категория+уровень после нормализации)

### Результат
✅ Словарь упорядочен, очищен от дубликатов и расширен до 3185 слов. Создан единый инструмент для поддержания качества словаря.

## [23.09.2025] - Учет последнего слова и детерминированный порядок ходов

## [24.09.2025] - Быстрый валидатор словаря с поддержкой stdin

### Изменено
- Валидатор `src/utils/validateWords.js` теперь читает данные из stdin (живой документ), а при отсутствии stdin — из `public/words.csv`.
- Производительность улучшена за счет прямой потоковой загрузки входа и раннего fallback.

### Инструкции
- Смотрите раздел "Словарь и валидация" в `README.md` для примеров запуска с учетом кодировок PowerShell.

### Результат
- Проверка словаря больше не зависит от сохранения файла на диск; можно валидировать текущий редактируемый документ.

### Исправлено
- Последнее угаданное слово корректно учитывается в статистике: сервер сначала рассылает `game_state`, затем `round_completed` при завершении раунда (как при последнем слове, так и при явном `end_round`).

### Изменено
- Порядок очереди ходов сделан детерминированным (без случайной перестановки команд/игроков) для стабильности поведения и тестов.

### Тесты
- Обновлены интеграционные тесты с учетом нового порядка событий и детерминированности. Все тесты проходят: 59/59.

## [24.09.2025] - Минимум 5 секунд для перенесённого времени на старте 2-го и 3-го раундов

### Изменено
- В `Game.startNextRound()` добавлен клэмп перенесённого времени игрока до минимальных 5 секунд при старте внутренних раундов 1 и 2 (соответствует 2-му и 3-му раундам по UX). Значение хранится в секундах.

### Тесты
- Добавлены unit-тесты: `1s→5s`, `4s→5s`, `6s` — без изменений.

### Документация
- Обновлены `README.md`, `TECHNICAL_NOTES.md`, `ProjectPlan.md` с описанием правила и единиц измерения.

## [24.09.2025] - Полировка UI и игрового потока; правки паузы; словарь

### Изменено
- Экран после 1-го раунда: вместо промежуточного счёта теперь сразу показывается экран правил 2-го раунда.
- Экраны правил (1–3 раунды): удалён пункт про время, чтобы не дублировать и не путать пользователей.

### Исправлено
- Пауза: во время паузы блокируются все кнопки, кроме кнопок «Пауза/Продолжить» и «Завершить игру»; при завершении и при инициализации игры блокировка автоматически снимается.

### Словарь
- Повторно выполнены нормализация и сортировка после ручных правок.
- Сгенерирована актуальная статистика словаря (`public/dictionary_statistics.md`).

### Документация
- Обновлены `README.md`, `ProjectPlan.md`, `TECHNICAL_NOTES.md` с актуальным поведением паузы и потока раундов.

## [21.09.2025] - Оптимизация документации проекта

### Добавлено
- **Структура документации**: Создан файл `DOCUMENTATION_STRUCTURE.md` с описанием назначения каждого документа
- **Четкое разделение**: Каждый документ теперь имеет уникальное назначение без дублирования
- **Ссылки между документами**: Добавлены перекрестные ссылки для удобной навигации

### Изменено
- **ProjectPlan.md**: Удалена история изменений и устаревшая информация, оставлены только актуальные планы
- **TECHNICAL_NOTES.md**: Оптимизирован для технических деталей, убрано дублирование
- **README.md**: Обновлен с актуальной информацией и ссылками на документацию
- **CHANGELOG.md**: Централизована вся история изменений проекта

### Удалено
- **Дублирование информации**: Убрано повторение логики переноса времени в разных документах
- **Устаревшие разделы**: Удалены планы будущих версий из ProjectPlan.md
- **Избыточные детали**: Упрощены описания в пользу четкой структуры

### Результат
✅ Документация стала более структурированной, актуальной и удобной для использования. Каждый документ имеет четкое назначение, дублирование информации устранено.

---

## [21.09.2025] - Исправление подсчета результатов для последнего слова

### Исправлено
- **Критическая ошибка**: Последнее слово в игре теперь корректно учитывается в статистике
- **Проблема**: При угадывании последнего слова в раунде счет не обновлялся, что приводило к расхождению между количеством угаданных слов и отображаемым счетом
- **Решение**: Изменена логика завершения раунда в функции `wordGuessed()` для корректной отправки обновленного состояния перед завершением

### Изменено
- **Функция `wordGuessed()`**: Добавлена проверка на окончание слов после удаления угаданного слова
- **Порядок операций**: Сначала отправляется обновленное состояние с финальным счетом, затем устанавливается `currentWord = null`
- **Логика завершения раунда**: Раунд завершается только после отправки корректного состояния клиентам

### Технические детали
- **Файлы**: `server.js`
- **Ключевые изменения**:
  ```javascript
  // Проверяем, не закончились ли слова после удаления угаданного слова
  if (gameState.availableWords.length === 0) {
    // Отправляем обновленное состояние с финальным счетом перед завершением раунда
    broadcastGameState();
    
    // Устанавливаем currentWord = null только после отправки состояния
    gameState.currentWord = null;
    
    endRound();
  }
  ```

### Тестирование
- Проведено комплексное тестирование с различным количеством слов (3, 20, 50)
- Подтверждено, что счет всегда соответствует количеству угаданных слов
- Последнее слово в игре теперь корректно учитывается в финальной статистике

### Результат
✅ Проблема с подсчетом результатов полностью решена. Теперь счет всегда точно соответствует количеству угаданных слов, включая последнее слово в игре.

---

## [21.09.2025] - Реализация подробной статистики игровых сессий

### Добавлено
- **Подробная статистика**: Два переключаемых экрана с детальной аналитикой результатов игры
- **Экран статистики команд**: Таблица с очками команд по раундам и общим итогом
- **Экран статистики игроков**: Таблица с личными результатами каждого игрока
- **Навигация между экранами**: Кнопки "Команды" и "Игроки" для переключения
- **Цветовая индикация очков**: 
  - 🟢 Зеленый для положительных очков
  - 🔴 Красный для отрицательных очков
  - ⚫ Серый для нулевых очков
- **Современный дизайн таблиц**: Тени, скругленные углы, адаптивный дизайн
- **Сортировка игроков**: По общим очкам в убывающем порядке

### Изменено
- **Структура данных**: Добавлены поля `teamStatsByRound` и `playerStats` в `gameState`
- **Сбор статистики**: Обновление в реальном времени при угадывании/пропуске слов
- **Экран результатов**: Заменен простой экран на два переключаемых экрана
- **События WebSocket**: Добавлено событие `game_ended` для уведомления о завершении игры
- **Цветовая схема**: Черный цвет для имен игроков и команд, цветная маркировка для очков

### Технические детали
- **Файлы**: `server.js`, `public/index.html`, `ProjectPlan.md`
- **Серверные изменения**:
  - Добавлены поля `teamStatsByRound` и `playerStats` в `gameState`
  - Обновление статистики в функциях `wordGuessed()` и `wordPassed()`
  - Инициализация статистики в `startGame()` и `startNextRound()`
  - Добавлено событие `game_ended` в `startNextRound()`
- **Клиентские изменения**:
  - Новые экраны: `teamResultsScreen` и `playerResultsScreen`
  - Функции: `showTeamStats()`, `showPlayerStats()`, `determineWinner()`, `getScoreClass()`
  - CSS стили для таблиц и навигации
  - Обработка события `game_ended` в WebSocket
- **Структура данных**:
  ```javascript
  teamStatsByRound: {
    0: { teamId: score }, // Раунд 1
    1: { teamId: score }, // Раунд 2  
    2: { teamId: score }  // Раунд 3
  }
  playerStats: {
    playerId: {
      guessed: number,    // Угадано слов
      passed: number,     // Пропущено слов
      totalScore: number  // Общие очки
    }
  }
  ```

### Результат
Игроки теперь получают подробную аналитику своих результатов с возможностью переключения между командной и личной статистикой. Таблицы показывают детальную информацию по раундам, что позволяет лучше анализировать игру и планировать стратегию на будущие сессии.

## [21.09.2025] - Добавление экрана представления игрока

### Добавлено
- **Экран представления игрока**: Новый экран, показывающийся перед каждым ходом игрока
- **Информация об игроке**: Отображение имени игрока и названия его команды
- **Кнопка "Начать"**: Переход к игровому экрану после подготовки
- **Красивые анимации**: 
  - Плавное появление экрана (`playerIntroSlideIn`)
  - Эффект свечения для имени игрока (`playerNameGlow`)
  - Анимации для информации об игроке (`playerInfoFadeIn`, `playerTeamSlideIn`)
- **Адаптивный дизайн**: Корректная работа на мобильных устройствах

### Изменено
- **Логика начала игры**: Первый ход теперь начинается с экрана представления игрока
- **Смена раундов**: При переходе к 2-му и 3-му раундам показывается экран представления игрока
- **Передача хода**: Обновлена логика для показа экрана представления после экрана передачи хода
- **Обработка game_state**: Добавлена логика для показа экрана в нужных случаях

### Технические детали
- **Файлы**: `public/index.html`, `ProjectPlan.md`
- **Новые функции**: `showPlayerIntroScreen()`, `startPlayerTurn()`
- **Обновленные функции**: `startFirstRound()`, `startSecondRound()`, `startThirdRound()`
- **Новые CSS классы**: `.player-intro-info`, `.current-player-info`, `.current-player-name`, `.current-player-team`
- **Новые анимации**: `@keyframes playerIntroSlideIn`, `@keyframes playerNameGlow`, `@keyframes playerInfoFadeIn`, `@keyframes playerTeamSlideIn`

### Результат
Игроки теперь видят красивый экран с информацией о том, чей сейчас ход, перед началом каждого хода. Это улучшает пользовательский опыт, делает игру более понятной и создает приятную атмосферу с анимациями и эффектами.

## [21.09.2025] - Добавление счетчика оставшихся слов

### Добавлено
- **Счетчик слов**: Отображение количества слов, которые еще предстоит показать (исключая текущее слово)
- **Динамическое обновление**: Счетчик обновляется в реальном времени при угадывании и пропуске слов
- **Цветовая индикация**: Автоматическое изменение цвета в зависимости от количества оставшихся слов:
  - 🔴 Красный: ≤ 10 слов (мало слов)
  - 🟠 Оранжевый: 11-25 слов (среднее количество)
  - 🟡 Желтый: > 25 слов (много слов)
- **Стилизованный дизайн**: Красивый счетчик с полупрозрачным фоном, скругленными углами и hover-эффектами

### Изменено
- **Текст счетчика**: "Еще слов - X" вместо "Слов в шляпе: X"
- **Логика подсчета**: `Math.max(0, gameState.availableWords.length - 1)` - исключает текущее показанное слово
- **Функция updateGameDisplay()**: Добавлено обновление счетчика слов с цветовой индикацией

### Технические детали
- **Файлы**: `public/index.html`
- **CSS класс**: `.words-counter` с анимациями и эффектами
- **JavaScript**: Обновлена функция `updateGameDisplay()` для отображения счетчика
- **Логика**: Счетчик показывает количество слов, которые еще предстоит объяснить

### Результат
✅ Игроки теперь видят точное количество слов, которые им еще предстоит объяснить, что улучшает планирование стратегии и понимание прогресса игры.

---

## [21.09.2025] - Исправление отображения слов и позиционирования кнопок

### Исправлено
- **Проблема с кнопками**: Кнопки "Верно" и "Пропуск" больше не сдвигаются вниз при отображении длинных слов
- **Проблема с переносом слов**: Слова теперь переносятся только по целым словам, а не по слогам
- **Проблема с фразами**: Длинные фразы корректно отображаются с переносом по словам

### Добавлено
- Новый CSS класс `.game-content` для лучшей структуры игрового экрана
- Ограничение максимальной высоты блока с текущим словом (200px на десктопе, 150px на мобильных)
- Прокрутка для очень длинных слов при необходимости
- Улучшенная адаптивность для мобильных устройств

### Изменено
- **CSS структура**: Изменен `.game-area` для использования `justify-content: space-between`
- **Перенос слов**: Заменен `word-break: break-word` на `word-break: keep-all`
- **HTML структура**: Добавлен блок `.game-content` для обертки таймера и слова
- **Мобильные стили**: Обновлены для корректной работы с новой структурой

### Технические детали
- **Файлы**: `public/index.html`
- **CSS свойства**: `word-break: keep-all`, `overflow-wrap: break-word`, `line-height: 1.2`
- **Структура**: Flexbox с фиксированным позиционированием кнопок

### Результат
✅ Кнопки управления зафиксированы внизу экрана, слова отображаются корректно без разрыва по слогам, улучшен пользовательский опыт на всех устройствах.

---

## [21.09.2025] - Дедупликация словаря и улучшение завершения работы сервера

### Исправлено
- **Критическая проблема**: Удалены дублирующиеся слова из игрового словаря
- **Проблема**: В словаре было найдено 6 дубликатов: "картина", "сумка", "рубашка", "зеркало", "салат", "кефир"
- **Решение**: Автоматическое удаление дубликатов с сохранением резервной копии

### Добавлено
- Функция `normalizeWord()` для нормализации слов согласно плану проекта
- Функция `checkForDuplicates()` для проверки точных и нормализованных дубликатов
- Автоматическая проверка дубликатов при загрузке словаря в `server.js`
- Улучшенная обработка завершения работы сервера с корректным закрытием WebSocket соединений
- Резервное копирование словаря перед изменениями

### Изменено
- Обновлен `public/words.csv`: количество слов уменьшено с 252 до 246 (удалено 6 дубликатов)
- Улучшена обработка сигнала `SIGINT` в `server.js` для корректного завершения работы
- Добавлено принудительное завершение через 5 секунд при зависании сервера

### Технические детали
- **Файлы**: `server.js`, `public/words.csv`, `public/words_backup_*.csv`
- **Ключевые функции**: `normalizeWord()`, `checkForDuplicates()`
- **Нормализация**: lowerCase → trim → замена "ё"→"е" → удаление пунктуации → схлопывание пробелов

### Результат
✅ Словарь очищен от дубликатов, сервер корректно завершает работу, добавлена защита от дубликатов в будущем.

---

## [21.09.2025] - Исправление логики переноса времени

### Исправлено
- **Критическая ошибка**: Логика переноса времени между раундами теперь учитывает только фактическое игровое время
- **Проблема**: Первоначальная реализация включала паузы между раундами в расчет перенесенного времени
- **Решение**: Использование `timerState.remainingTime` вместо текущего клиентского времени

### Добавлено
- Функция `calculateCarriedTime()` для корректного вычисления перенесенного времени
- Функция `endRoundByWordsExhausted()` для правильного завершения раунда по исчерпанию слов
- Отслеживание времени начала раунда (`roundStartTime`)
- Отслеживание времени пауз (`pausedDuration`, `pauseStartTime`)

### Изменено
- Обновлена функция `startTimer()` для фиксации времени начала раунда
- Обновлены функции `pauseTimer()` и `resumeTimer()` для отслеживания пауз
- Обновлена обработка события `round_completed` с проверкой состояния таймера
- Разделена логика завершения раунда по истечению времени и по исчерпанию слов

### Технические детали
- **Файлы**: `public/index.html`, `ProjectPlan.md`, `TECHNICAL_NOTES.md` (раздел "Реализация переноса времени на клиенте")
- **Ключевые функции**: `calculateCarriedTime()`, `endRoundByWordsExhausted()`
- **Состояние таймера**: Добавлены поля `roundStartTime`, `pausedDuration`, `pauseStartTime`

### Результат
✅ Перенос времени теперь работает корректно и учитывает только фактическое игровое время, исключая паузы между раундами.

---

### 21.09.2025 - Исправление логики записи оставшегося времени хода игрока

**Проблема**: Время игроков накапливалось в `playerCarriedTime` и не очищалось при завершении игры, что приводило к утечке памяти и некорректной логике.

**Внесенные изменения**:

1. **Очистка времени при завершении игры**:
   - Добавлена очистка `playerCarriedTime = {}` в функции `startNextRound()` при завершении игры
   - Добавлена очистка `playerCarriedTime = {}` в функции `startGame()` при начале новой игры
   - Добавлено логирование очистки времени для отладки

2. **Упрощение логики хранения времени**:
   - Обновлены комментарии для ясности логики
   - Время хранится только для текущего игрока, очищается при завершении игры
   - Убрана избыточная логика накопления времени по всем игрокам

3. **Соответствие требованиям**:
   - Время НЕ переносится между играми (как требовалось)
   - Данные очищаются при завершении игры (как требовалось)
   - Минимизировано общение с сервером (время хранится на клиенте)

**Ключевые изменения в коде**:
```javascript
// В функции startGame()
gameState.playerCarriedTime = {};
console.log('Перенесенное время очищено при начале новой игры');

// В функции startNextRound() при завершении игры
gameState.playerCarriedTime = {};
console.log('Перенесенное время очищено при завершении игры');
```

**Результат**: Логика записи оставшегося времени хода игрока теперь корректна - время не накапливается между играми, очищается при завершении партии, и минимизировано общение с сервером.

----

## [Предыдущие версии]

### Первоначальная реализация
- Базовая логика переноса времени на клиенте
- Использование localStorage для хранения перенесенного времени
- Интеграция с серверной логикой для совместимости

---

## [21.09.2025] - Исправление логики записи оставшегося времени хода игрока

### Исправлено
- **Критическая проблема**: Время игроков накапливалось в `playerCarriedTime` и не очищалось при завершении игры, что приводило к утечке памяти и некорректной логике.

### Изменено
- **Функция `startGame()`**: Добавлена очистка `playerCarriedTime = {}` при начале новой игры
- **Функция `startNextRound()`**: Добавлена очистка `playerCarriedTime = {}` при завершении игры
- **Логирование**: Добавлено логирование очистки времени для отладки

### Технические детали
- **Файлы**: `server.js`
- **Ключевые изменения**:
  ```javascript
  // В функции startGame()
  gameState.playerCarriedTime = {};
  console.log('Перенесенное время очищено при начале новой игры');
  
  // В функции startNextRound() при завершении игры
  gameState.playerCarriedTime = {};
  console.log('Перенесенное время очищено при завершении игры');
  ```

### Результат
✅ Логика записи оставшегося времени хода игрока теперь корректна - время не накапливается между играми, очищается при завершении партии, и минимизировано общение с сервером. Предотвращены утечки памяти и обеспечена стабильная работа приложения.