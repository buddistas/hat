# История изменений - Hat Web

## [21.09.2025] - Дедупликация словаря и улучшение завершения работы сервера

### Исправлено
- **Критическая проблема**: Удалены дублирующиеся слова из игрового словаря
- **Проблема**: В словаре было найдено 6 дубликатов: "картина", "сумка", "рубашка", "зеркало", "салат", "кефир"
- **Решение**: Автоматическое удаление дубликатов с сохранением резервной копии

### Добавлено
- Функция `normalizeWord()` для нормализации слов согласно плану проекта
- Функция `checkForDuplicates()` для проверки точных и нормализованных дубликатов
- Автоматическая проверка дубликатов при загрузке словаря в `server.js`
- Улучшенная обработка завершения работы сервера с корректным закрытием WebSocket соединений
- Резервное копирование словаря перед изменениями

### Изменено
- Обновлен `public/words.csv`: количество слов уменьшено с 252 до 246 (удалено 6 дубликатов)
- Улучшена обработка сигнала `SIGINT` в `server.js` для корректного завершения работы
- Добавлено принудительное завершение через 5 секунд при зависании сервера

### Технические детали
- **Файлы**: `server.js`, `public/words.csv`, `public/words_backup_*.csv`
- **Ключевые функции**: `normalizeWord()`, `checkForDuplicates()`
- **Нормализация**: lowerCase → trim → замена "ё"→"е" → удаление пунктуации → схлопывание пробелов

### Результат
✅ Словарь очищен от дубликатов, сервер корректно завершает работу, добавлена защита от дубликатов в будущем.

---

## [21.09.2025] - Исправление логики переноса времени

### Исправлено
- **Критическая ошибка**: Логика переноса времени между раундами теперь учитывает только фактическое игровое время
- **Проблема**: Первоначальная реализация включала паузы между раундами в расчет перенесенного времени
- **Решение**: Использование `timerState.remainingTime` вместо текущего клиентского времени

### Добавлено
- Функция `calculateCarriedTime()` для корректного вычисления перенесенного времени
- Функция `endRoundByWordsExhausted()` для правильного завершения раунда по исчерпанию слов
- Отслеживание времени начала раунда (`roundStartTime`)
- Отслеживание времени пауз (`pausedDuration`, `pauseStartTime`)

### Изменено
- Обновлена функция `startTimer()` для фиксации времени начала раунда
- Обновлены функции `pauseTimer()` и `resumeTimer()` для отслеживания пауз
- Обновлена обработка события `round_completed` с проверкой состояния таймера
- Разделена логика завершения раунда по истечению времени и по исчерпанию слов

### Технические детали
- **Файлы**: `public/index.html`, `ProjectPlan.md`, `TIME_CARRY_IMPLEMENTATION.md`
- **Ключевые функции**: `calculateCarriedTime()`, `endRoundByWordsExhausted()`
- **Состояние таймера**: Добавлены поля `roundStartTime`, `pausedDuration`, `pauseStartTime`

### Результат
✅ Перенос времени теперь работает корректно и учитывает только фактическое игровое время, исключая паузы между раундами.

---

## [Предыдущие версии]

### Первоначальная реализация
- Базовая логика переноса времени на клиенте
- Использование localStorage для хранения перенесенного времени
- Интеграция с серверной логикой для совместимости
