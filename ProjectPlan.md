# Hat Web — План проекта (RU)

## Оглавление
- [1. Цели и ограничения](#1-цели-и-ограничения)
- [2. Технологический стек](#2-технологический-стек)
- [3. Основные поставки (MVP)](#3-основные-поставки-mvp)
- [4. Этапы и сроки](#4-этапы-и-сроки)
- [5. Команды](#5-команды)
- [6. Структура приложения](#6-структура-приложения)
- [7. Реализация правил игры](#7-реализация-правил-игры)
- [8. Структура данных](#8-структура-данных-текущая-реализация)
- [9. Нормализация слов](#9-нормализация-слов)
- [10. Состояния игры](#10-состояния-игры)
- [11. Таймер и перенос времени](#11-таймер-и-перенос-времени)
- [12. Распределение и порядок слов](#12-распределение-и-порядок-слов)
- [13. Экраны и UX‑особенности](#13-экраны-и-uxособенности)
- [14. Аналитика и статистика](#14-аналитика-и-статистика)
- [15. План тестирования](#15-план-тестирования)
- [16. Производительность и доступность](#16-производительность-и-доступность)
- [17. Критерии приёмки (MVP)](#17-критерии-приёмки-mvp)
- [18. Текущий статус проекта](#18-текущий-статус-проекта)
 - [19. Принципы пополнения словаря](#19-принципы-пополнения-словаря)

---

## 1. Цели и ограничения
- **Тип игры**: Настольная игра на одном устройстве, передаваемая от игрока к игроку (однопользовательское приложение)
- **Синхронизация**: Не требуется, игра работает на одном устройстве без серверной зависимости
- **Безопасность**: Игроки не используют читы, безопасность не критична
- **Сетевые условия**: Не принципиальны, цель - минимизировать зависимость от интернета
- **Архитектура**: Клиентская реализация логики переноса времени для автономности
- Один девайс, режим pass-and-play; 4–20 игроков суммарно.
- Три раунда: 1) свободное объяснение, 2) жесты/мимика, 3) одно слово.
- Ход 60 секунд; PASS = −1 очко; угаданное = +1 очко.
- Раунд заканчивается, когда «шляпа» пуста; игра завершается, когда пуста шляпа в раунде 3.
- Перенос времени между раундами (ceil до секунды); следующий раунд начинает тот же игрок, и первая попытка использует только перенесённые секунды (без базовых 60s).
- Базовый словарь RU; брендовые названия отображаются в оригинале (латиницей), нормализация особым путём.
- Пользовательские слова — отдельная категория внутри базового RU-пака; глобальная дедупликация. Каждое слово (или фраза) может принадлежать только одной категории.
- Mobile-first, портретная ориентация, вибрация + звук, офлайн‑режим с восстановлением.
- Звук обязателен для игрового опыта; приложение не предоставляет «тихий режим».
- На экране хода доступна пауза/возобновление для ведущего игрока.
- Ответы подтверждаются вручную: текущий игрок нажимает «Верно», приложение не анализирует корректность ответа.
- Глобальная статистика и Telegram‑аутентификация — на серверной фазе.

## 2. Технологический стек (MVP - упрощенный)
- Frontend: Vanilla HTML/CSS/JavaScript с WebSocket подключением для реактивности
- Backend: Node.js с WebSocket сервером для раздачи статической страницы и обработки JSON событий
- Таймер: Полностью клиентский с `performance.now()` + `requestAnimationFrame`
- Данные: Слова в отдельном файле через запятую (один файл, все слова в одной строке)
- UI: Интерфейс аналогичный приложению Hat Up (http://apps.apple.com/ru/app/hat-up/id1472656524)
- Архитектура: Одна комната, многопользовательская игра на одном устройстве (pass-and-play)

## 3. Основные поставки (MVP)
- MVP: полный 3‑раундный цикл, таймер с переносом, подсчёт очков/штрафы, базовый словарь из файла, итоги с «интересными фактами», вибро/звук
- WebSocket сервер: раздача статической страницы, обработка JSON событий между клиентом и сервером
- Интерфейс: повторение UI приложения Hat Up для знакомого пользовательского опыта
- Архитектура: pass-and-play на одном устройстве, одна комната для всех игроков

## 4. Этапы и сроки
- M1: Node.js WebSocket сервер + статическая HTML страница с базовым UI. (1 день)
- M2: Игровая логика: 3 раунда, таймер с переносом, подсчёт очков, базовый словарь из файла. (1 день)
- M3: WebSocket события: JSON коммуникация между клиентом и сервером. (1 день)
- M4: UI аналогичный Hat Up: экраны настройки, игры, результатов. (1 день)
- M5: Звук, вибрация, пауза/возобновление, финальная полировка. (1 день)

## 5. Команды
- Количество команд: 2–4.
- Размер команды: от 2 до 5 игроков.
- Балансировка: максимальная разница в численности между командами — 1 игрок.
- Распределение игроков:
  - Кнопка авто‑распределения по командам с возможностью повторного реролла.
  - Возможность ручного заполнения/редактирования составов.

## 6. Структура приложения
```
hat_web/
  server.js          # Node.js WebSocket сервер
  package.json       # Зависимости Node.js
  public/
    index.html       # Статическая страница с встроенным CSS/JS
    words.csv        # Словарь через запятую
```

## 7. Реализация правил игры
- Общий пул слов на всю игру; каждый раунд переиспользует слова, пока все не будут угаданы.
- `PASS` немедленно снижает очки команды на 1 (−1) и фиксируется в логе событий.
- Перенос времени (carry‑over):
  - Если раунд исчерпан во время активного хода, следующий раунд начинает тот же игрок с ceil(remainingSeconds).
  - Первая попытка следующего раунда использует только перенесённые секунды (без базовых 60s).
  - Все последующие попытки в раунде — стандартные 60s.
  - Если раунд завершился ровно в момент истечения хода (time up), перенос не применяется.
  - **Время НЕ переносится между играми** - очищается при завершении партии.
  - **Данные очищаются при завершении игры** - предотвращает накопление и утечки памяти.
- Очки могут уходить в отрицательные значения; нижних границ нет.

### 7.1. Логика очередности ходов
- **Инициализация очереди**: При старте игры формируется фиксированная очередь ходов:
  - Случайный порядок команд (перемешивание массива команд)
  - Случайный порядок игроков внутри каждой команды
  - Структура данных `turnOrder`:
    ```js
    turnOrder: {
      teams: [], // Порядок команд (случайный)
      playersByTeam: {}, // Порядок игроков внутри каждой команды (случайный)
      currentTeamIndex: 0, // Индекс текущей команды в очереди
      currentPlayerIndex: 0 // Индекс текущего игрока в команде
    }
    ```

- **Алгоритм переключения ходов**:
  1. Ход переходит к следующей команде в очереди (`currentTeamIndex++`)
  2. Если достигнут конец списка команд (`currentTeamIndex === 0`), переходим к следующему игроку (`currentPlayerIndex++`)
  3. Если индекс игрока превышает количество игроков в команде, сбрасываем на 0
  4. Выбираем игрока: `teams[currentTeamIndex].playersByTeam[currentPlayerIndex]`

- **Перемешивание слов при смене игрока**:
  - При каждом переходе хода к новому игроку слова в пуле перемешиваются заново
  - Используется алгоритм Fisher-Yates для равномерного распределения
  - Пропущенные слова остаются в пуле и могут достаться любому игроку

- **Экран представления игрока**:
  - Показывается перед каждым ходом игрока, включая первый
  - Отображает имя текущего игрока и его команду
  - Имеет красивую анимацию появления с эффектом свечения
  - Позволяет игрокам подготовиться к своему ходу
  - Переходит к игровому экрану по нажатию кнопки "Начать"

- **Экран передачи хода**:
  - Показывается между ходами игроков для плавного перехода
  - Отображает имя следующего игрока и его команду
  - Позволяет игрокам подготовиться к своему ходу
  - Автоматически переходит к экрану представления игрока по нажатию "Старт"

- **Правило повторной выдачи PASS-слов**:
  - Пропущенные слова перемещаются в конец очереди `availableWords`
  - Могут достаться тому же игроку только если в пуле не осталось других слов
  - Статистика пропусков ведется отдельно для аналитики

## 8. Структура данных (текущая реализация)

### gameState (сервер)
```javascript
{
  gameId: string,
  players: Array<{id: string, name: string, teamId: string}>,
  teams: Array<{id: string, name: string, playerIds: string[]}>,
  currentRound: 0 | 1 | 2,
  currentPlayer: {id: string, name: string, teamId: string},
  currentWord: string | null,
  availableWords: string[],
  usedWords: string[],
  teamStatsByRound: {
    0: {[teamId: string]: number},
    1: {[teamId: string]: number}, 
    2: {[teamId: string]: number}
  },
  playerStats: {
    [playerId: string]: {
      guessed: number,
      passed: number,
      totalScore: number
    }
  },
  playerCarriedTime: {[playerId: string]: number} // Очищается при завершении игры
}
```

## 9. Нормализация слов
- Регистр: в хранимом CSV все СЛОВА (первая колонка) фиксируются В ВЕРХНЕМ РЕГИСТРЕ; категории и уровень сохраняют исходный регистр/написание.
- Кириллица: upperCase → trim → нормализация пробелов (схлопывание) → нормализация тире (– — − → `-`) и апострофов (’ ` ´ → `'`) → trim. «Ё» при сортировке приравнивается к «Е» (колляция ru, sensitivity=base).
- Бренды (латиница): переводятся в верхний регистр, спецсимволы не изменяются, кроме нормализации пробелов/апострофов/тире.
- Пользовательские слова: дефис/тире и апостроф разрешены; эмодзи запрещены.
- В исходном базовом словаре разрешены любые символы (кроме эмодзи в пользовательском вводе).
- Дедуп-линия: точные дубли записей (слово+категория+уровень после нормализации) удаляются.

## 10. Состояния игры
- Состояния: `lobby` → `setup` → `preround(r)` → `handoff` → `turnActive` → `turnEnd` → `roundReview` → `roundEnd` → `preround(r+1)` → … → `gameSummary`
- События: `GAME_CREATED`, `TEAMS_CONFIGURED`, `START_ROUND`, `START_TURN`, `PAUSE`, `RESUME`, `GUESS_OK`, `PASS`, `TIMER_TICK`, `TIMER_EXPIRED`, `END_TURN`, `ROUND_DEPLETED`, `CARRY_TIME`, `START_NEXT_ROUND`, `END_GAME`

## 11. Таймер и перенос времени
- **Архитектура**: Полностью клиентский таймер с использованием `performance.now()` + `requestAnimationFrame`.
- **Хранение времени**: Использование `localStorage` для сохранения перенесенного времени между раундами
- **Корректировка**: Автоматическая корректировка через событие `visibilitychange` при возвращении в фокус.
- **Формулы**:
  - `remainingTime = max(0, duration - (now - startTime))`
  - `carry = ceil(remainingTime / 1000)` - перенос времени между раундами
- **Особенности**:
  - Точность до миллисекунд
  - Устойчивость к проблемам фоновых вкладок
  - Поддержка паузы/возобновления
  - Перенос времени только на первую попытку следующего раунда
  - **Автономность**: Полная независимость от сервера для логики времени
  - **Надежность**: Работает без интернет-соединения
  - **Очистка данных**: Время НЕ переносится между играми, очищается при завершении партии

## 12. Распределение и порядок слов
- Порядок слов в каждом раунде — случайный.
- Равномерность выдачи между игроками не гарантируется.
- Пропущенное слово может вновь достаться тому же игроку только если в шляпе не осталось других слов.
 - Подтверждение угадывания выполняется вручную: ведущий нажимает «Верно» при слышимом правильном ответе.

### 12.1. Порядок и сортировка словаря (CSV)
- Формат CSV: `слово,категория,уровень` (без заголовка или с заголовком — опционально).
- Сортировка: сначала по категории (алфавит `ru`, `sensitivity=base`), затем по слову (алфавит `ru`, `sensitivity=base`).
- Уровень (`обычный`/`повышенный`) не влияет на порядок сортировки.
- При записи соблюдается верхний регистр только для колонки «слово».

## 13. Экраны и UX‑особенности
- Start/Lobby, Setup (имена 1–24 символа; 4–20 игроков; имя обязательно; опционально `@username`), Rules, PlayerIntro (экран представления игрока с анимацией), Handoff, Turn (крупное слово, таймер, кнопки `Угадано`/`Пас`), Review, Results, Dictionary, Settings.
- Раунд 2 без текстовых подсказок (только жесты/мимика).
- Вибро: старт(60ms), T−5s([30,40,30]), guessed/pass(25ms), конец(120ms).
- Звук: обязателен. Короткий стартовый сигнал, одиночный на `T−5s`, длинный на окончание, клики кнопок (прелоад). Экран первичного «разблокирования аудио» по первому тапу. Отдельного «тихого режима» нет.
- Учитывать системные настройки по возможности, но отдельного «тихого режима» нет.
- На экране хода — кнопка `Пауза/Возобновить`; при паузе блокируются все кнопки, кроме паузы и завершения игры; блокировка снимается при завершении/инициализации игры.
- **Счетчик слов**: Отображение "Еще слов - X" на экране хода с динамическим обновлением и цветовой индикацией (красный ≤10, оранжевый 11-25, желтый >25 слов).

## 14. Аналитика и статистика
- **Статистика команд**: очки по раундам (teamStatsByRound), общий счет, определение победителя
- **Личная статистика игроков**: количество угаданных слов, пропущенных слов, общие очки
- **Отображение**: два переключаемых экрана с таблицами статистики в финальных результатах
- **Цветовая индикация**: зеленый (положительные очки), красный (отрицательные), серый (ноль)

## 15. План тестирования
- Unit: клиентский таймер, подсчёт с −1 за PASS, переиспользование пула между раундами, нормализация/дедуп
- Component: Turn (моки таймера/вибро/звука), Review, Dictionary (валидация/ошибки)
- E2E: полный 3‑раундный матч с переносом, восстановление после перезагрузки, сценарий Пауза/Возобновить

## 16. Производительность и доступность
- Мемоизация, минимум лишних перерисовок, предзагрузка аудио
- Высокая контрастность, крупные тач‑таргеты, ARIA по необходимости
- Портретная ориентация; мягкие подсказки при повороте устройства

## 17. Критерии приёмки (MVP)
- Полный 3‑раундный цикл с переносом времени (ceil) и штрафами.
- Корректная очистка времени при завершении игры (предотвращение утечек памяти).
- 2–4 команды; 2–5 игроков в команде; макс. разница между командами — 1 игрок.
- Авто‑распределение с рероллом и ручное редактирование составов.
- PASS даёт −1 очко; возможны отрицательные очки.
- Пользовательские слова — отдельная категория; дедуп работает для кириллицы/латиницы; эмодзи запрещены.
- Порядок слов — случайный; правило повторной выдачи PASS‑слова соблюдается.
- Звук обязателен; вибро и звук работают в критических точках; экран разблокировки аудио; отдельного «тихого режима» нет.
- RU‑локализация; офлайн‑режим; восстановление сессии.
- На экране хода доступна пауза/возобновление; во время паузы действия заблокированы, события логируются.
- Подтверждение угадывания выполняется вручную кнопкой «Верно» текущего игрока; автоматическая проверка отсутствует.
- Тесты: ключевые unit/component + минимум 3 E2E‑сценария (полный матч, восстановление, пауза/мьют/распределение).

## 18. Текущий статус проекта

### Реализованные функции (MVP)
- ✅ Полный 3-раундный цикл игры
- ✅ Таймер с переносом времени между раундами
- ✅ Подсчет очков и штрафов
- ✅ Базовый словарь из файла
- ✅ WebSocket сервер для синхронизации
- ✅ Интерфейс аналогичный Hat Up
- ✅ Подробная статистика команд и игроков
- ✅ Экран представления игрока
- ✅ Счетчик оставшихся слов
- ✅ Корректная очистка данных при завершении игры

### Технические особенности
- **Архитектура**: Pass-and-play на одном устройстве
- **Таймер**: Полностью клиентский с `performance.now()`
- **Данные**: Слова в CSV файле, статистика в памяти
- **UI**: Mobile-first дизайн с анимациями
- **Совместимость**: Обратная совместимость сохранена

### Планы развития
- Сохранение состояния игры
- Глобальная статистика игроков
- Факты о прошедшей партии
- Добавление пользовательских слов
- Черный список
- Самобалансирующаяся сложность
- Рейтинги
- Округление остатка времени
- Офлайн режим
- Исправление бага с правилами второго раунда

## 19. Принципы пополнения словаря
- **Оглавление**: первая строка - всегда оглавление.
- **Регистр и язык**: слова фиксируются В ВЕРХНЕМ РЕГИСТРЕ; категории/уровни — в естественном регистре. Язык — русский без транслитераций/англицизмов при наличии устоявшихся аналогов.
- **Формат фраз**: многословные фразы записываются без кавычек; на фронте кавычки не отображаются.
- **Сложность**: не более 20% записей в каждой категории имеют уровень «повышенный», преимущественно для низкочастотных/специализированных терминов (определяется по текущему словарю и здравому смыслу).
- **Дубликаты**: глобально запрещены после нормализации (`ё→е`, удаление пунктуации, схлопывание пробелов). Частично пересекающиеся фразы (типа «электронный будильник» и «будильник») одновременно не допускаются.
- **Обработка дубликатов (оперативно)**: при обнаружении точного дубликата НЕ переименовывать и НЕ переносить — удалить одну из дублей (в любой категории), оставив единственный экземпляр.
- **Категориальные границы**: 
  - «Знаменитости» допускает реальных и вымышленных персонажей.
  - «Архитектура и городская среда» включает стили, элементы и термины, а не только объекты.
  - «Фильмы и сериалы» и «Книги и литература» — без ограничений по типу сущностей (термины и конкретные названия), но без кавычек.
- **Фокус контента**: приоритет русскоязычного контекста при включении международно известных имен/названий.
- **Порядок и сортировка**: словарь хранится отсортированным по категориям и по алфавиту внутри категории. Новые записи при коммите проходят автонормализацию и автосортировку.
- **Ограничения содержания**: тематические ограничения не применяются (политика/острые темы допустимы); в медицине допускаются диагнозы, процедуры, анатомия; избегать коммерческих брендов лекарств.
- **Каденция поставок**: добавление ведётся партиями по ~200 слов на итерацию (2 категории × ~100) с валидацией после каждой итерации.