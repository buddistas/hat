# Hat Web — План проекта (RU)

## Оглавление
- [1. Цели и ограничения](#1-цели-и-ограничения)
- [2. Технологический стек](#2-технологический-стек)
- [3. Основные поставки (MVP → сервер)](#3-основные-поставки-mvp--сервер)
- [4. Этапы и сроки (индикативно)](#4-этапы-и-сроки-индикативно)
- [5. Команды](#5-команды)
- [6. Структура приложения (target)](#6-структура-приложения-target)
- [7. Реализация правил игры](#7-реализация-правил-игры)
- [8. Данные (клиент, Dexie)](#8-данные-клиент-dexie)
- [9. Нормализация и дедупликация](#9-нормализация-и-дедупликация)
- [10. Стейт‑машина (XState) — состояния и события](#10-стейтмашина-xstate--состояния-и-события)
- [11. Таймер и устойчивость в фоне](#11-таймер-и-устойчивость-в-фоне)
- [12. Распределение и порядок слов](#12-распределение-и-порядок-слов)
- [13. Экраны и UX‑особенности](#13-экраны-и-uxособенности)
- [14. Аналитика сессии и «интересные факты»](#14-аналитика-сессии-и-интересные-факты)
- [15. Сервер (фаза 2) — черновик API](#15-сервер-фаза-2--черновик-api)
- [16. План тестирования](#16-план-тестирования)
- [17. PWA и офлайн](#17-pwa-и-офлайн)
- [18. Производительность и доступность](#18-производительность-и-доступность)
- [19. Критерии приёмки (MVP)](#19-критерии-приёмки-mvp)
- [20. История изменений и исправлений](#20-история-изменений-и-исправлений)

---

## 1. Цели и ограничения
- **Тип игры**: Настольная игра на одном устройстве, передаваемая от игрока к игроку (однопользовательское приложение)
- **Синхронизация**: Не требуется, игра работает на одном устройстве без серверной зависимости
- **Безопасность**: Игроки не используют читы, безопасность не критична
- **Сетевые условия**: Не принципиальны, цель - минимизировать зависимость от интернета
- **Архитектура**: Клиентская реализация логики переноса времени для автономности
- Один девайс, режим pass-and-play; 4–20 игроков суммарно.
- Три раунда: 1) свободное объяснение, 2) жесты/мимика, 3) одно слово.
- Ход 60 секунд; PASS = −1 очко; угаданное = +1 очко.
- Раунд заканчивается, когда «шляпа» пуста; игра завершается, когда пуста шляпа в раунде 3.
- Перенос времени между раундами (ceil до секунды); следующий раунд начинает тот же игрок, и первая попытка использует только перенесённые секунды (без базовых 60s).
- Базовый словарь RU; брендовые названия отображаются в оригинале (латиницей), нормализация особым путём.
- Пользовательские слова — отдельная категория внутри базового RU-пака; глобальная дедупликация. Каждое слово (или фраза) может принадлежать только одной категории.
- Mobile-first, портретная ориентация, вибрация + звук, офлайн‑режим с восстановлением.
- Звук обязателен для игрового опыта; приложение не предоставляет «тихий режим».
- На экране хода доступна пауза/возобновление для ведущего игрока.
- Ответы подтверждаются вручную: текущий игрок нажимает «Верно», приложение не анализирует корректность ответа.
- Глобальная статистика и Telegram‑аутентификация — на серверной фазе.

## 2. Технологический стек (MVP - упрощенный)
- Frontend: Vanilla HTML/CSS/JavaScript с WebSocket подключением для реактивности
- Backend: Node.js с WebSocket сервером для раздачи статической страницы и обработки JSON событий
- Таймер: Полностью клиентский с `performance.now()` + `requestAnimationFrame`
- Данные: Слова в отдельном файле через запятую (один файл, все слова в одной строке)
- UI: Интерфейс аналогичный приложению Hat Up (http://apps.apple.com/ru/app/hat-up/id1472656524)
- Архитектура: Одна комната, многопользовательская игра на одном устройстве (pass-and-play)

## 3. Основные поставки (MVP - упрощенный)
- MVP: полный 3‑раундный цикл, таймер с переносом, подсчёт очков/штрафы, базовый словарь из файла, итоги с «интересными фактами», вибро/звук
- WebSocket сервер: раздача статической страницы, обработка JSON событий между клиентом и сервером
- Интерфейс: повторение UI приложения Hat Up для знакомого пользовательского опыта
- Архитектура: pass-and-play на одном устройстве, одна комната для всех игроков

## 4. Этапы и сроки (MVP - упрощенный)
- M1: Node.js WebSocket сервер + статическая HTML страница с базовым UI. (1 день)
- M2: Игровая логика: 3 раунда, таймер с переносом, подсчёт очков, базовый словарь из файла. (1 день)
- M3: WebSocket события: JSON коммуникация между клиентом и сервером. (1 день)
- M4: UI аналогичный Hat Up: экраны настройки, игры, результатов. (1 день)
- M5: Звук, вибрация, пауза/возобновление, финальная полировка. (1 день)

## 5. Команды
- Количество команд: 2–4.
- Размер команды: от 2 до 5 игроков.
- Балансировка: максимальная разница в численности между командами — 1 игрок.
- Распределение игроков:
  - Кнопка авто‑распределения по командам с возможностью повторного реролла.
  - Возможность ручного заполнения/редактирования составов.

## 6. Структура приложения (MVP - упрощенный)
```
hat_web/
  server.js          # Node.js WebSocket сервер
  package.json       # Зависимости Node.js
  public/
    index.html       # Статическая страница с встроенным CSS/JS
    words.csv        # Словарь через запятую
```

## 7. Реализация правил игры
- Общий пул слов на всю игру; каждый раунд переиспользует слова, пока все не будут угаданы.
- `PASS` немедленно снижает очки команды на 1 (−1) и фиксируется в логе событий.
- Перенос времени (carry‑over):
  - Если раунд исчерпан во время активного хода, следующий раунд начинает тот же игрок с ceil(remainingSeconds).
  - Первая попытка следующего раунда использует только перенесённые секунды (без базовых 60s).
  - Все последующие попытки в раунде — стандартные 60s.
  - Если раунд завершился ровно в момент истечения хода (time up), перенос не применяется.
- Очки могут уходить в отрицательные значения; нижних границ нет.

### 7.1. Логика очередности ходов
- **Инициализация очереди**: При старте игры формируется фиксированная очередь ходов:
  - Случайный порядок команд (перемешивание массива команд)
  - Случайный порядок игроков внутри каждой команды
  - Структура данных `turnOrder`:
    ```js
    turnOrder: {
      teams: [], // Порядок команд (случайный)
      playersByTeam: {}, // Порядок игроков внутри каждой команды (случайный)
      currentTeamIndex: 0, // Индекс текущей команды в очереди
      currentPlayerIndex: 0 // Индекс текущего игрока в команде
    }
    ```

- **Алгоритм переключения ходов**:
  1. Ход переходит к следующей команде в очереди (`currentTeamIndex++`)
  2. Если достигнут конец списка команд (`currentTeamIndex === 0`), переходим к следующему игроку (`currentPlayerIndex++`)
  3. Если индекс игрока превышает количество игроков в команде, сбрасываем на 0
  4. Выбираем игрока: `teams[currentTeamIndex].playersByTeam[currentPlayerIndex]`

- **Перемешивание слов при смене игрока**:
  - При каждом переходе хода к новому игроку слова в пуле перемешиваются заново
  - Используется алгоритм Fisher-Yates для равномерного распределения
  - Пропущенные слова остаются в пуле и могут достаться любому игроку

- **Экран представления игрока**:
  - Показывается перед каждым ходом игрока, включая первый
  - Отображает имя текущего игрока и его команду
  - Имеет красивую анимацию появления с эффектом свечения
  - Позволяет игрокам подготовиться к своему ходу
  - Переходит к игровому экрану по нажатию кнопки "Начать"

- **Экран передачи хода**:
  - Показывается между ходами игроков для плавного перехода
  - Отображает имя следующего игрока и его команду
  - Позволяет игрокам подготовиться к своему ходу
  - Автоматически переходит к экрану представления игрока по нажатию "Старт"

- **Правило повторной выдачи PASS-слов**:
  - Пропущенные слова перемещаются в конец очереди `availableWords`
  - Могут достаться тому же игроку только если в пуле не осталось других слов
  - Статистика пропусков ведется отдельно для аналитики

## 8. Данные (клиент, Dexie) - для будущих версий
```ts
// Таблицы IndexedDB (Dexie)
type WordPack = { id: string; version: number; locale: 'ru'; name: string; updatedAt: number; categories: string[] };
type Word = { id: string; packId: string; text: string; normalized: string; category: string; addedByUsername?: string; createdAt: number };
type DedupeIndex = { normalized: string; wordId: string };

type Game = {
  id: string;
  createdAt: number;
  updatedAt: number;
  settings: { roundDurationSec: 60; passPenalty: 1; carryRemainder: true };
  players: { id: string; displayName: string; username?: string; telegramId?: string | null }[];
  teams: { id: string; name: string; playerIds: string[]; scoreByRound: [number, number, number] }[];
  roundIndex: 0 | 1 | 2;
  currentTurn?: { playerId: string; teamId: string; startedAtMs: number; endsAtMs: number; roundIndex: 0 | 1 | 2; carriedFromPrev?: number };
  pool: {
    allWordIds: string[];
    usedByRound: Record<0 | 1 | 2, string[]>;
    guessedByRound: Record<0 | 1 | 2, string[]>;
  };
  carrySecondsR1toR2?: number;
  carrySecondsR2toR3?: number;
  eventsLogId: string;
};

type EventLogItem = { id: string; gameId: string; ts: number; type: string; payload?: unknown };
// Важные типы событий:
// game_started, round_started, turn_started, pause, resume, word_shown,
// guess_ok{wordId, guessTimeMs}, pass{wordId}, turn_ended, round_ended, game_ended

type PendingStat = { id: string; gameId: string; ts: number; type: string; payload: unknown; username?: string; telegramId?: string; sent?: boolean };
type PendingWordSubmission = { id: string; wordText: string; normalized: string; category: string; addedByUsername?: string; sent?: boolean };
```

## 9. Нормализация и дедупликация
- Кириллица: lowerCase → trim → заменить «ё»→«е» → удалить пунктуацию `[.,!?:;"'()\-–—]` → схлопнуть пробелы → trim.
- Бренды (латиница): не применять кириллические правила; хранить также normalizedLatin = toLowerCase(trim) для сопоставления.
- Пользовательские слова: разрешены дефис/тире и апостроф; эмодзи запрещены.
- В исходном базовом словаре разрешены любые символы (кроме эмодзи в пользовательском вводе).
- Дедуп‑индекс проверяет обе дорожки нормализации; при конфликте — отказ с подсказкой пользователю.

## 10. Стейт‑машина (XState) — состояния и события
- Состояния: `lobby` → `setup` → `preround(r)` → `handoff` → `turnActive` → `turnEnd` → `roundReview` → `roundEnd` → `preround(r+1)` → … → `gameSummary`
- События: `GAME_CREATED`, `TEAMS_CONFIGURED`, `START_ROUND`, `START_TURN`, `PAUSE`, `RESUME`, `GUESS_OK`, `PASS`, `TIMER_TICK`, `TIMER_EXPIRED`, `END_TURN`, `ROUND_DEPLETED`, `CARRY_TIME`, `START_NEXT_ROUND`, `END_GAME`

## 11. Таймер и устойчивость в фоне
- **Архитектура**: Полностью клиентский таймер с использованием `performance.now()` + `requestAnimationFrame`.
- **Хранение времени**: Использование `localStorage` для сохранения перенесенного времени между раундами
- **Корректировка**: Автоматическая корректировка через событие `visibilitychange` при возвращении в фокус.
- **Формулы**:
  - `remainingTime = max(0, duration - (now - startTime))`
  - `carry = ceil(remainingTime / 1000)` - перенос времени между раундами
- **Особенности**:
  - Точность до миллисекунд
  - Устойчивость к проблемам фоновых вкладок
  - Поддержка паузы/возобновления
  - Перенос времени только на первую попытку следующего раунда
  - **Автономность**: Полная независимость от сервера для логики времени
  - **Надежность**: Работает без интернет-соединения
- **Исправления логики переноса времени** (обновлено 21.09.2025):
  - Учет только фактического игрового времени (исключение пауз между раундами)
  - Функция `calculateCarriedTime()` использует `timerState.remainingTime`
  - Функция `endRoundByWordsExhausted()` для корректного завершения раунда по исчерпанию слов
  - Разделение логики для завершения по истечению времени (перенос = 0) и по исчерпанию слов (перенос = остаток)

## 12. Распределение и порядок слов
- Порядок слов в каждом раунде — случайный.
- Равномерность выдачи между игроками не гарантируется.
- Пропущенное слово может вновь достаться тому же игроку только если в шляпе не осталось других слов.
 - Подтверждение угадывания выполняется вручную: ведущий нажимает «Верно» при слышимом правильном ответе.

## 13. Экраны и UX‑особенности
- Start/Lobby, Setup (имена 1–24 символа; 4–20 игроков; имя обязательно; опционально `@username`), Rules, PlayerIntro (экран представления игрока с анимацией), Handoff, Turn (крупное слово, таймер, кнопки `Угадано`/`Пас`), Review, Results, Dictionary, Settings.
- Раунд 2 без текстовых подсказок (только жесты/мимика).
- Вибро: старт(60ms), T−10s([30,40,30]), guessed/pass(25ms), конец(120ms).
- Звук: обязателен. Короткий стартовый сигнал, двойной на `T−10s`, длинный на окончание, клики кнопок (прелоад). Экран первичного «разблокирования аудио» по первому тапу. Отдельного «тихого режима» нет.
- Учитывать системные настройки по возможности, но отдельного «тихого режима» нет.
 - На экране хода — кнопка `Пауза/Возобновить`; при паузе блокируются действия угадывания/пасса, логируются события.
- **Счетчик слов**: Отображение "Еще слов - X" на экране хода с динамическим обновлением и цветовой индикацией (красный ≤10, оранжевый 11-25, желтый >25 слов).

## 14. Аналитика сессии и «интересные факты»
- Игрок/раунд: guessedCount, passCount, points = guessed − pass, avgGuessTimeMs.
- Команда: pointsByRound, totalPoints, winner.
- Факты: самое медленное/быстрое угадывание, самое частое PASS‑слово, игрок с наибольшим количеством PASS, секунды переноса между раундами, персональные рекорды (сравнение при синхронизации).
- Отображение подробной аналитики — только в итогах.

## 15. Сервер (фаза 2) — черновик API
```
POST /auth/telegram/validate          -> { token, user:{ telegramId, username, displayName } }
GET  /dictionary/packs?sinceVersion=… -> { added, updated, removed, version }
POST /dictionary/submit               -> { status }  // body: { word, category, username? }
POST /stats/events                    -> idem; body: [{ eventId, ts, type, payload, username?, telegramId? }]
GET  /leaderboard
GET  /me
```
- БД (PostgreSQL, Prisma): users, word_packs, words, user_submitted_words(status), games, game_results, player_stats.
- Антифрод: не требуется на MVP.
 - Идентификация до Telegram: `guestId` (PWA), последующее слияние с Telegram‑профилем при входе.
 - Версионирование словаря: глобальный монотонный integer `dictionaryVersion`; дельты по `?sinceVersion`.

## 16. План тестирования
- Unit: клиентский таймер (performance.now, requestAnimationFrame, visibilitychange, ceil для переноса, 0–1s, кейс «ровно по таймеру», перенос только на первую попытку), подсчёт с −1 за PASS, переиспользование пула между раундами, нормализация/дедуп (кириллица/латиница), валидации пользовательских слов (тотальный запрет эмодзи, разрешённые символы «&», «+», апострофы в брендах), правило повторной выдачи PASS‑слова.
- Component: Turn (моки таймера/вибро/звука), Review, Dictionary (валидация/ошибки, дедуп‑подсказки).
- E2E (Playwright): полный 3‑раундный матч с переносом; восстановление после перезагрузки (IndexedDB снапшоты); добавление пользовательского слова + отклонение дублей; сценарий Пауза/Возобновить; авто‑распределение и ручное редактирование; тестирование таймера при переключении вкладок.
- Contract (сервер): аутентификация, словарь (дельты/удаления), статистика (идемпотентность/версионирование).

## 17. PWA и офлайн
- Workbox‑service worker: кеширование оболочки, статические ассеты, очереди фоновой синхронизации.
- Снапшоты IndexedDB и авто‑resume при старте приложения, ретеншн по политике (например, 10 последних сессий или 30 дней).
- Манифест/иконки; бюджет Lighthouse.

## 18. Производительность и доступность
- Мемоизация, минимум лишних перерисовок, предзагрузка аудио.
- Высокая контрастность, крупные тач‑таргеты, ARIA по необходимости.
- Портретная ориентация; мягкие подсказки при повороте устройства.

## 19. Критерии приёмки (MVP)
- Полный 3‑раундный цикл с переносом времени (ceil) и штрафами.
- 2–4 команды; 2–5 игроков в команде; макс. разница между командами — 1 игрок.
- Авто‑распределение с рероллом и ручное редактирование составов.
- PASS даёт −1 очко; возможны отрицательные очки.
- Пользовательские слова — отдельная категория; дедуп работает для кириллицы/латиницы; эмодзи запрещены.
- Порядок слов — случайный; правило повторной выдачи PASS‑слова соблюдается.
- Звук обязателен; вибро и звук работают в критических точках; экран разблокировки аудио; отдельного «тихого режима» нет.
- RU‑локализация; офлайн‑режим; восстановление сессии.
- На экране хода доступна пауза/возобновление; во время паузы действия заблокированы, события логируются.
- Подтверждение угадывания выполняется вручную кнопкой «Верно» текущего игрока; автоматическая проверка отсутствует.
- Тесты: ключевые unit/component + минимум 3 E2E‑сценария (полный матч, восстановление, пауза/мьют/распределение).

## 20. История изменений и исправлений

### 21.09.2025 - Добавление счетчика оставшихся слов

**Добавлено**: Счетчик слов на экране игры для улучшения пользовательского опыта.

**Внесенные изменения**:

1. **Визуальный счетчик слов**:
   - Добавлен элемент `.words-counter` на экран игры
   - Отображает текст "Еще слов - X" где X - количество слов, которые еще предстоит показать
   - Исключает текущее показанное слово из подсчета

2. **Динамическое обновление**:
   - Счетчик обновляется в реальном времени при угадывании и пропуске слов
   - Интегрирован в функцию `updateGameDisplay()`

3. **Цветовая индикация**:
   - 🔴 Красный: ≤ 10 слов (мало слов)
   - 🟠 Оранжевый: 11-25 слов (среднее количество)  
   - 🟡 Желтый: > 25 слов (много слов)

4. **Стилизация**:
   - Полупрозрачный фон с blur-эффектом
   - Скругленные углы и hover-эффекты
   - Адаптивный дизайн

**Результат**: Игроки теперь видят точное количество слов, которые им еще предстоит объяснить, что улучшает планирование стратегии и понимание прогресса игры.

### 21.09.2025 - Исправление логики переноса времени

**Проблема**: Первоначальная реализация вычисляла перенесенное время на основе разности между временем запуска таймера и текущим клиентским временем, что включало паузы между раундами.

**Внесенные изменения**:

1. **Добавление отслеживания времени начала раунда**:
   - В функцию `startTimer` добавлено сохранение времени начала раунда в переменную `roundStartTime`
   - Добавлено поле `pausedDuration` для отслеживания общего времени пауз

2. **Обновление функций паузы и возобновления**:
   - Функции `pauseTimer` и `resumeTimer` теперь отслеживают время пауз
   - Добавлено поле `pauseStartTime` для фиксации начала паузы

3. **Реализация функции вычисления перенесенного времени**:
   - Добавлена функция `calculateCarriedTime()`, использующая `timerState.remainingTime`
   - Добавлена функция `endRoundByWordsExhausted()` для корректного завершения раунда по исчерпанию слов

4. **Обновление обработки завершения раунда**:
   - Разделена логика для завершения по истечению времени (перенос = 0) и по исчерпанию слов (перенос = остаток)
   - Обновлена обработка события `round_completed` с проверкой состояния таймера

5. **Обновление состояния таймера**:
   - Добавлены поля: `roundStartTime`, `pausedDuration`, `pauseStartTime`
   - Обновлена функция `resetTimer` для сброса новых полей

**Результат**: Логика переноса времени теперь учитывает только фактическое игровое время, исключая паузы между раундами, что обеспечивает точность и корректность переноса времени между раундами.

### 21.09.2025 - Добавление экрана представления игрока

**Добавлено**: Экран представления игрока перед каждым ходом для улучшения пользовательского опыта.

**Внесенные изменения**:

1. **Новый экран представления игрока**:
   - Создан экран `playerIntroScreen` с красивым дизайном
   - Отображает имя текущего игрока и название его команды
   - Имеет кнопку "Начать" для перехода к игровому экрану

2. **Стилизация и анимации**:
   - Добавлены анимации появления экрана (`playerIntroSlideIn`)
   - Эффект свечения для имени игрока (`playerNameGlow`)
   - Анимации для информации об игроке (`playerInfoFadeIn`, `playerTeamSlideIn`)
   - Адаптивный дизайн для мобильных устройств

3. **Интеграция в игровую логику**:
   - Экран показывается перед каждым ходом игрока, включая первый
   - Интегрирован в логику смены раундов (2-й и 3-й раунды)
   - Правильно обрабатывает перенесенное время между раундами
   - Работает совместно с существующим экраном передачи хода

4. **JavaScript функции**:
   - Добавлена функция `showPlayerIntroScreen()` для отображения экрана
   - Добавлена функция `startPlayerTurn()` для начала хода игрока
   - Обновлена логика обработки `game_state` для показа экрана в нужных случаях
   - Обновлены функции `startFirstRound()`, `startSecondRound()`, `startThirdRound()`

5. **Обновление документации**:
   - Добавлено описание экрана представления игрока в раздел логики очередности ходов
   - Обновлен раздел экранов и UX-особенностей
   - Добавлена запись в историю изменений

**Результат**: Игроки теперь видят красивый экран с информацией о том, чей сейчас ход, перед началом каждого хода. Это улучшает пользовательский опыт, делает игру более понятной и создает приятную атмосферу с анимациями и эффектами.
