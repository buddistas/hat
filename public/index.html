<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–®–ª—è–ø–∞ - –ò–≥—Ä–∞ –≤ —Å–ª–æ–≤–∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        .setup-form {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
        }

        .btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .current-word {
            font-size: 3rem;
            font-weight: bold;
            margin: 30px 0;
            padding: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-word;
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-controls-top {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .game-controls .btn {
            flex: 1;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }

        .btn-small {
            padding: 8px 16px !important;
            font-size: 14px !important;
            margin: 0 !important;
            flex: none !important;
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .scores {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            min-width: 100px;
        }

        .score-item h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .score-item .score {
            font-size: 2rem;
            font-weight: bold;
            color: #ffeb3b;
        }

        .round-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .player-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .results {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .results h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .winner {
            text-align: center;
            margin: 20px 0;
            font-size: 1.5rem;
            color: #ffeb3b;
            font-weight: bold;
        }

        .team-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .teams-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .teams-container::-webkit-scrollbar {
            width: 6px;
        }

        .teams-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .teams-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .teams-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .team-item h3 {
            margin-bottom: 10px;
            color: #ffeb3b;
            font-size: 1.1rem;
        }

        .team-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .player-tag {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .handoff-info {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .next-player-info {
            margin: 30px 0;
        }

        .next-player-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .next-player-team {
            font-size: 1.3rem;
            opacity: 0.9;
            color: white;
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .current-word {
                font-size: 2rem;
                padding: 20px;
            }
            
            .game-controls {
                flex-direction: column;
            }

            .game-controls-top {
                flex-direction: column;
                gap: 8px;
            }

            .teams-container {
                max-height: 300px;
            }

            .player-tag {
                font-size: 12px;
                padding: 4px 8px;
            }

            .team-item {
                padding: 12px;
            }

            .team-item h3 {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</div>
    
    <div class="container">
        <div class="header">
            <h1>üé© –®–ª—è–ø–∞</h1>
            <p>–ò–≥—Ä–∞ –≤ —Å–ª–æ–≤–∞ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏</p>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã -->
        <div class="screen active" id="setupScreen">
            <div class="setup-form">
                <h2 style="text-align: center; margin-bottom: 30px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–≥—Ä—ã</h2>
                
                <div class="form-group">
                    <label for="playerCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</label>
                    <select id="playerCount">
                        <option value="4">4 –∏–≥—Ä–æ–∫–∞</option>
                        <option value="5">5 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="6">6 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="7">7 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="8">8 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="9">9 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="10">10 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="11">11 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="12">12 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="13">13 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="14">14 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="15">15 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="16">16 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="17">17 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="18">18 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="19">19 –∏–≥—Ä–æ–∫–æ–≤</option>
                        <option value="20">20 –∏–≥—Ä–æ–∫–æ–≤</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="teamCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–∞–Ω–¥:</label>
                    <select id="teamCount">
                        <option value="2">2 –∫–æ–º–∞–Ω–¥—ã</option>
                        <option value="3">3 –∫–æ–º–∞–Ω–¥—ã</option>
                        <option value="4">4 –∫–æ–º–∞–Ω–¥—ã</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="roundDuration">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ö–æ–¥–∞ (—Å–µ–∫—É–Ω–¥—ã):</label>
                    <select id="roundDuration">
                        <option value="30">30 —Å–µ–∫—É–Ω–¥</option>
                        <option value="60" selected>60 —Å–µ–∫—É–Ω–¥</option>
                        <option value="90">90 —Å–µ–∫—É–Ω–¥</option>
                    </select>
                </div>

                <button class="btn" onclick="setupTeams()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥ -->
        <div class="screen" id="teamsScreen">
            <div class="setup-form">
                <h2 style="text-align: center; margin-bottom: 30px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–º–∞–Ω–¥</h2>
                
                <div class="form-group">
                    <label>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º:</label>
                    <div class="teams-container">
                        <div id="teamsList" style="margin-top: 15px;"></div>
                    </div>
                    <button class="btn btn-secondary" onclick="shuffleTeams()" style="margin-top: 15px;">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã</button>
                </div>

                <button class="btn" onclick="setupWords()">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ–≤–∞</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–≤ -->
        <div class="screen" id="wordsScreen">
            <div class="setup-form">
                <h2 style="text-align: center; margin-bottom: 30px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª–æ–≤</h2>
                
                <div class="form-group">
                    <label for="wordsCount">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ —à–ª—è–ø–µ:</label>
                    <select id="wordsCount">
                        <option value="20">20 —Å–ª–æ–≤</option>
                        <option value="30">30 —Å–ª–æ–≤</option>
                        <option value="40">40 —Å–ª–æ–≤</option>
                        <option value="50">50 —Å–ª–æ–≤</option>
                        <option value="60">60 —Å–ª–æ–≤</option>
                        <option value="70">70 —Å–ª–æ–≤</option>
                        <option value="80">80 —Å–ª–æ–≤</option>
                        <option value="90">90 —Å–ª–æ–≤</option>
                        <option value="100" selected>100 —Å–ª–æ–≤</option>
                        <option value="120">120 —Å–ª–æ–≤</option>
                        <option value="140">140 —Å–ª–æ–≤</option>
                        <option value="160">160 —Å–ª–æ–≤</option>
                        <option value="180">180 —Å–ª–æ–≤</option>
                        <option value="200">200 —Å–ª–æ–≤</option>
                    </select>
                </div>

                <div class="form-group">
                    <p style="text-align: center; opacity: 0.8; font-size: 14px; margin-top: 10px;">
                        –°–ª–æ–≤–∞ –±—É–¥—É—Ç –≤—ã–±—Ä–∞–Ω—ã —Å–ª—É—á–∞–π–Ω—ã–º –æ–±—Ä–∞–∑–æ–º –∏–∑ –∏–≥—Ä–æ–≤–æ–≥–æ —Å–ª–æ–≤–∞—Ä—è
                    </p>
                </div>

                <button class="btn" onclick="startGame()">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
        <div class="screen" id="gameScreen">
            <div class="game-controls-top">
                <button class="btn btn-secondary btn-small" onclick="pauseGame()" id="pauseBtn">–ü–∞—É–∑–∞</button>
                <button class="btn btn-danger btn-small" onclick="endGame()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
            </div>
            
            <div class="round-info" id="roundInfo">–†–∞—É–Ω–¥ 1 –∏–∑ 3</div>
            <div class="player-info" id="playerInfo">–•–æ–¥ –∏–≥—Ä–æ–∫–∞</div>
            
            <div class="game-area">
                <div class="timer" id="timer">60</div>
                <div class="current-word" id="currentWord">–ù–∞–∂–º–∏—Ç–µ "–ü—Ä–æ–ø—É—Å–∫" –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–ª–æ–≤–∞</div>
                
                <div class="game-controls">
                    <button class="btn btn-success" onclick="wordGuessed()">–í–µ—Ä–Ω–æ</button>
                    <button class="btn btn-warning" onclick="wordPassed()">–ü—Ä–æ–ø—É—Å–∫</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –ø–µ—Ä–µ–¥–∞—á–∏ —Ö–æ–¥–∞ -->
        <div class="screen" id="handoffScreen">
            <div class="game-area">
                <div class="handoff-info">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #ffeb3b;">–ü–µ—Ä–µ–¥–∞—á–∞ —Ö–æ–¥–∞</h2>
                    <div class="next-player-info">
                        <div class="next-player-name" id="nextPlayerName">–ò–≥—Ä–æ–∫</div>
                        <div class="next-player-team" id="nextPlayerTeam">–ö–æ–º–∞–Ω–¥–∞</div>
                    </div>
                    <div class="handoff-message">
                        <p style="text-align: center; font-size: 1.2rem; margin: 30px 0; opacity: 0.9;">
                            –ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å —Ö–æ–¥?
                        </p>
                    </div>
                    <button class="btn" onclick="startNextTurn()" id="startTurnBtn">–°—Ç–∞—Ä—Ç</button>
                </div>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Å—á–µ—Ç–∞ –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏ -->
        <div class="screen" id="roundScoresScreen">
            <div class="results">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—É–Ω–¥–∞</h2>
                <div class="scores" id="roundScores"></div>
                
                <div class="next-round-rules" id="nextRoundRules" style="margin: 30px 0; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 15px; border: 1px solid rgba(255,255,255,0.2);">
                    <h3 style="text-align: center; margin-bottom: 15px; color: #ffeb3b;">–ü—Ä–∞–≤–∏–ª–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞</h3>
                    <p id="nextRoundDescription" style="text-align: center; font-size: 1.1rem; line-height: 1.5;"></p>
                </div>
                
                <button class="btn" onclick="continueToNextRound()" id="continueBtn">–ù–∞—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
        <div class="screen" id="resultsScreen">
            <div class="results">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–≥—Ä—ã</h2>
                <div class="winner" id="winner"></div>
                <div class="scores" id="finalScores"></div>
                <button class="btn" onclick="newGame()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let gameState = {};
        let gameSetup = {
            players: [],
            teams: [],
            roundDuration: 60,
            wordsCount: 100
        };

        // –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ç–∞–π–º–µ—Ä —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º performance.now()
        let timerState = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            duration: 60000, // 60 —Å–µ–∫—É–Ω–¥ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
            remainingTime: 60000,
            animationFrameId: null,
            carriedTime: 0, // –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –º–µ–∂–¥—É —Ä–∞—É–Ω–¥–∞–º–∏
            roundStartTime: null, // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
            pausedDuration: 0, // –û–±—â–µ–µ –≤—Ä–µ–º—è –ø–∞—É–∑ –≤ —Ä–∞—É–Ω–¥–µ
            pauseStartTime: null // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–π –ø–∞—É–∑—ã
        };

        // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                console.log('–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:', message.type);
                
                if (message.type === 'game_state') {
                    gameState = message.data;
                    console.log('–ü–æ–ª—É—á–µ–Ω game_state —Å playerCarriedTime:', gameState.playerCarriedTime);
                    updateGameDisplay();
                    
                    // –ï—Å–ª–∏ –º—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∏–≥—Ä—ã –∏ —Ç–∞–π–º–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ —Å —É—á–µ—Ç–æ–º carriedTime
                    if (document.getElementById('gameScreen').classList.contains('active') && !timerState.isRunning) {
                        const currentPlayerCarriedTime = gameState.playerCarriedTime && gameState.currentPlayer 
                            ? (gameState.playerCarriedTime[gameState.currentPlayer.id] || 0)
                            : 0;
                        
                        console.log('–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è game_state:');
                        console.log('- currentPlayer:', gameState.currentPlayer);
                        console.log('- currentPlayerCarriedTime:', currentPlayerCarriedTime);
                        
                        startTimer(gameSetup.roundDuration, currentPlayerCarriedTime);
                    }
                } else if (message.type === 'round_completed') {
                    console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ round_completed:', message.data);
                    gameState.currentRound = message.data.currentRound;
                    gameState.scores = message.data.scores;
                    
                    // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä –µ—â–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–Ω–∞—á–∏—Ç —Ä–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –ø–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é —Å–ª–æ–≤
                    // –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã—á–∏—Å–ª–∏—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                    if (timerState.isRunning) {
                        endRoundByWordsExhausted();
                    }
                    // –ï—Å–ª–∏ —Ç–∞–π–º–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–æ
                    
                    showRoundScores();
                    showScreen('roundScoresScreen');
                } else if (message.type === 'handoff_screen') {
                    console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–±—ã—Ç–∏–µ handoff_screen:', message.data);
                    showHandoffScreen(message.data);
                } else if (message.type === 'error') {
                    alert('–û—à–∏–±–∫–∞: ' + message.message);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket –æ—Ç–∫–ª—é—á–µ–Ω');
                updateConnectionStatus(false);
                // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                status.className = 'connection-status connected';
            } else {
                status.textContent = '–û—Ç–∫–ª—é—á–µ–Ω–æ';
                status.className = 'connection-status disconnected';
            }
        }

        function sendEvent(type, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, data }));
            } else {
                console.error('WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
            }
        }

        function setupTeams() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const teamCount = parseInt(document.getElementById('teamCount').value);
            const roundDuration = parseInt(document.getElementById('roundDuration').value);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
            if (playerCount < 4 || playerCount > 20) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 4 –¥–æ 20.');
                return;
            }
            
            // –°–æ–∑–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –∏ –∫–æ–º–∞–Ω–¥
            const players = [];
            const teams = [];
            
            for (let i = 1; i <= playerCount; i++) {
                players.push({
                    id: `player_${i}`,
                    name: `–ò–≥—Ä–æ–∫ ${i}`
                });
            }
            
            for (let i = 1; i <= teamCount; i++) {
                teams.push({
                    id: `team_${i}`,
                    name: `–ö–æ–º–∞–Ω–¥–∞ ${i}`,
                    players: []
                });
            }
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
            players.forEach((player, index) => {
                const teamIndex = index % teamCount;
                teams[teamIndex].players.push(player.id);
            });
            
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            gameSetup.players = players;
            gameSetup.teams = teams;
            gameSetup.roundDuration = roundDuration;
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥
            displayTeams();
            showScreen('teamsScreen');
        }

        function displayTeams() {
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = '';
            
            gameSetup.teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-item';
                
                const playersHtml = team.players.map(playerId => {
                    const player = gameSetup.players.find(p => p.id === playerId);
                    return `<span class="player-tag">${player.name}</span>`;
                }).join('');
                
                teamDiv.innerHTML = `
                    <h3>${team.name}</h3>
                    <div class="team-players">${playersHtml}</div>
                `;
                
                teamsList.appendChild(teamDiv);
            });
        }

        function shuffleTeams() {
            const playerCount = gameSetup.players.length;
            const teamCount = gameSetup.teams.length;
            
            // –û—á–∏—Å—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
            gameSetup.teams.forEach(team => {
                team.players = [];
            });
            
            // –°–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
            const shuffledPlayers = [...gameSetup.players].sort(() => Math.random() - 0.5);
            
            shuffledPlayers.forEach((player, index) => {
                const teamIndex = index % teamCount;
                gameSetup.teams[teamIndex].players.push(player.id);
            });
            
            displayTeams();
        }

        function setupWords() {
            showScreen('wordsScreen');
        }

        function startGame() {
            const wordsCount = parseInt(document.getElementById('wordsCount').value);
            gameSetup.wordsCount = wordsCount;
            
            // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–π –∏–≥—Ä—ã
            clearCarriedTime();
            
            sendEvent('start_game', {
                players: gameSetup.players,
                teams: gameSetup.teams,
                roundDuration: gameSetup.roundDuration,
                wordsCount: gameSetup.wordsCount
            });
            
            showScreen('gameScreen');
            startTimer(gameSetup.roundDuration);
        }


        function wordGuessed() {
            const currentTeam = getCurrentTeam();
            if (currentTeam) {
                sendEvent('word_guessed', { teamId: currentTeam.id });
            }
        }

        function wordPassed() {
            const currentTeam = getCurrentTeam();
            if (currentTeam) {
                sendEvent('word_passed', { teamId: currentTeam.id });
            }
        }

        function pauseGame() {
            const pauseBtn = document.getElementById('pauseBtn');
            if (timerState.isPaused) {
                sendEvent('resume_game');
                pauseBtn.textContent = '–ü–∞—É–∑–∞';
                resumeTimer();
            } else {
                sendEvent('pause_game');
                pauseBtn.textContent = '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å';
                pauseTimer();
            }
        }

        function endGame() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É?')) {
                showScreen('resultsScreen');
                showResults();
            }
        }

        function newGame() {
            showScreen('setupScreen');
            stopTimer();
            // –°–±—Ä–æ—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–≥—Ä—ã
            gameSetup = {
                players: [],
                teams: [],
                roundDuration: 60,
                wordsCount: 100
            };
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞
            resetTimer();
        }

        function getCurrentTeam() {
            if (!gameState.teams || !gameState.currentPlayer) return null;
            
            for (const team of gameState.teams) {
                if (team.players && team.players.includes(gameState.currentPlayer.id)) {
                    return team;
                }
            }
            return null;
        }

        function updateGameDisplay() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞—É–Ω–¥–µ
            const roundInfo = document.getElementById('roundInfo');
            if (gameState.currentRound !== undefined) {
                roundInfo.textContent = `–†–∞—É–Ω–¥ ${gameState.currentRound + 1} –∏–∑ 3`;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –∏–≥—Ä–æ–∫–µ
            const playerInfo = document.getElementById('playerInfo');
            if (gameState.currentPlayer) {
                playerInfo.textContent = `–•–æ–¥: ${gameState.currentPlayer.name}`;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞
            const currentWord = document.getElementById('currentWord');
            if (gameState.currentWord) {
                currentWord.textContent = gameState.currentWord;
            } else {
                currentWord.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            }
        }

        function updateScores() {
            const scoresContainer = document.getElementById('scores');
            scoresContainer.innerHTML = '';
            
            if (gameState.teams && gameState.scores) {
                gameState.teams.forEach(team => {
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'score-item';
                    scoreDiv.innerHTML = `
                        <h3>${team.name}</h3>
                        <div class="score">${gameState.scores[team.id] || 0}</div>
                    `;
                    scoresContainer.appendChild(scoreDiv);
                });
            }
        }

        function showRoundScores() {
            const roundScores = document.getElementById('roundScores');
            const nextRoundDescription = document.getElementById('nextRoundDescription');
            const continueBtn = document.getElementById('continueBtn');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ–º–∞–Ω–¥
            roundScores.innerHTML = '';
            if (gameState.teams && gameState.scores) {
                gameState.teams.forEach(team => {
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'score-item';
                    scoreDiv.innerHTML = `
                        <h3>${team.name}</h3>
                        <div class="score">${gameState.scores[team.id] || 0}</div>
                    `;
                    roundScores.appendChild(scoreDiv);
                });
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
            const currentPlayerCarriedTime = gameState.playerCarriedTime && gameState.currentPlayer 
                ? (gameState.playerCarriedTime[gameState.currentPlayer.id] || 0)
                : 0;
            
            if (currentPlayerCarriedTime > 0) {
                const timeInfo = document.createElement('div');
                timeInfo.className = 'score-item';
                timeInfo.style.marginTop = '20px';
                timeInfo.innerHTML = `
                    <h3>–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                    <div class="score">${currentPlayerCarriedTime} —Å–µ–∫</div>
                `;
                roundScores.appendChild(timeInfo);
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞—É–Ω–¥–∞
            const nextRound = gameState.currentRound + 1;
            let rulesText = '';
            let buttonText = '';
            
            if (nextRound === 1) {
                rulesText = '–û–±—ä—è—Å–Ω—è–π—Ç–µ —Å–ª–æ–≤–∞ —Å–ª–æ–≤–∞–º–∏, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—è –æ–¥–Ω–æ–∫–æ—Ä–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞, –∂–µ—Å—Ç—ã –∏–ª–∏ —Å–æ–∑–≤—É—á–∏—è.';
                buttonText = '–ù–∞—á–∞—Ç—å 1-–π —Ä–∞—É–Ω–¥';
            } else if (nextRound === 2) {
                rulesText = '–û–±—ä—è—Å–Ω—è–π—Ç–µ —Å–ª–æ–≤–∞ –∂–µ—Å—Ç–∞–º–∏ –∏ –º–∏–º–∏–∫–æ–π. –°–ª–æ–≤–∞ –∑–∞–ø—Ä–µ—â–µ–Ω—ã!';
                buttonText = '–ù–∞—á–∞—Ç—å 2-–π —Ä–∞—É–Ω–¥';
            } else if (nextRound === 3) {
                rulesText = '–û–±—ä—è—Å–Ω—è–π—Ç–µ –∫–∞–∂–¥–æ–µ —Å–ª–æ–≤–æ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∏–º —Å–ª–æ–≤–æ–º. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Ç–æ—á–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ —Å—É—Ç—å!';
                buttonText = '–ù–∞—á–∞—Ç—å 3-–π —Ä–∞—É–Ω–¥';
            } else {
                rulesText = '–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
                buttonText = '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã';
            }
            
            nextRoundDescription.textContent = rulesText;
            continueBtn.textContent = buttonText;
        }

        function continueToNextRound() {
            const nextRound = gameState.currentRound + 1;
            
            if (nextRound > 3) {
                // –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                showResults();
                showScreen('resultsScreen');
            } else {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Ä–∞—É–Ω–¥—É
                sendEvent('continue_round');
                showScreen('gameScreen');
                
                console.log('continueToNextRound - –∂–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è game_state –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞');
                // –¢–∞–π–º–µ—Ä –±—É–¥–µ—Ç –∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ game_state
            }
        }

        function showResults() {
            const winner = document.getElementById('winner');
            const finalScores = document.getElementById('finalScores');
            
            if (gameState.teams && gameState.scores) {
                let maxScore = -Infinity;
                let winnerTeam = null;
                
                gameState.teams.forEach(team => {
                    const score = gameState.scores[team.id] || 0;
                    if (score > maxScore) {
                        maxScore = score;
                        winnerTeam = team;
                    }
                });
                
                if (winnerTeam) {
                    winner.textContent = `üèÜ –ü–æ–±–µ–¥–∏–ª–∞ ${winnerTeam.name}!`;
                }
                
                // –ü–æ–∫–∞–∑ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Å—á–µ—Ç–æ–≤
                finalScores.innerHTML = '';
                gameState.teams.forEach(team => {
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'score-item';
                    scoreDiv.innerHTML = `
                        <h3>${team.name}</h3>
                        <div class="score">${gameState.scores[team.id] || 0}</div>
                    `;
                    finalScores.appendChild(scoreDiv);
                });
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º –≤—Ä–µ–º–µ–Ω–∏ –≤ localStorage
        function saveCarriedTime(timeLeft) {
            if (timeLeft > 0) {
                localStorage.setItem('hatGame_carriedTime', timeLeft.toString());
                console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:', timeLeft, '—Å–µ–∫—É–Ω–¥');
            } else {
                localStorage.removeItem('hatGame_carriedTime');
                console.log('–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—á–∏—â–µ–Ω–æ');
            }
        }

        function loadCarriedTime() {
            const saved = localStorage.getItem('hatGame_carriedTime');
            const carriedTime = saved ? parseFloat(saved) : 0;
            console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:', carriedTime, '—Å–µ–∫—É–Ω–¥');
            return carriedTime;
        }

        function clearCarriedTime() {
            localStorage.removeItem('hatGame_carriedTime');
            console.log('–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –æ—á–∏—â–µ–Ω–æ');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function calculateCarriedTime() {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≤—ã—á–∏—Å–ª–µ–Ω–Ω–æ–µ –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è –∏–∑ —Ç–∞–π–º–µ—Ä–∞
            // timerState.remainingTime —É–∂–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–∞—É–∑—ã –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã—á–∏—Å–ª–µ–Ω–æ
            const carriedTime = Math.max(0, timerState.remainingTime);
            
            console.log('calculateCarriedTime:', {
                remainingTime: Math.round(timerState.remainingTime / 1000) + 's',
                duration: Math.round(timerState.duration / 1000) + 's',
                carriedTime: Math.round(carriedTime / 1000) + 's',
                isRunning: timerState.isRunning,
                isPaused: timerState.isPaused
            });

            return Math.ceil(carriedTime / 1000); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞—É–Ω–¥–∞ –ø–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é —Å–ª–æ–≤
        function endRoundByWordsExhausted() {
            console.log('–†–∞—É–Ω–¥ –∑–∞–≤–µ—Ä—à–µ–Ω –ø–æ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—é —Å–ª–æ–≤');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            stopTimer();
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Å—Ç–∞–≤—à–µ–≥–æ—Å—è –≤—Ä–µ–º–µ–Ω–∏
            const carriedTime = calculateCarriedTime();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ localStorage
            saveCarriedTime(carriedTime);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            if (carriedTime > 0) {
                sendEvent('round_completed_carried_time', { carriedTime: carriedTime });
            }
            
            console.log('–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞—É–Ω–¥–∞:', carriedTime, '—Å–µ–∫—É–Ω–¥');
        }

        // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º–µ—Ä–æ–º
        function startTimer(durationSeconds, carriedTimeSeconds = 0) {
            stopTimer();
            
            console.log('startTimer –≤—ã–∑–≤–∞–Ω —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:', { durationSeconds, carriedTimeSeconds });
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –∏–∑ localStorage, –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–æ —è–≤–Ω–æ
            const loadedCarriedTime = carriedTimeSeconds > 0 ? carriedTimeSeconds : loadCarriedTime();
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –µ–≥–æ, –∏–Ω–∞—á–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –≤—Ä–µ–º—è
            const actualDuration = loadedCarriedTime > 0 ? loadedCarriedTime : durationSeconds;
            const totalDuration = actualDuration * 1000;
            
            console.log('startTimer - loadedCarriedTime:', loadedCarriedTime, 'actualDuration:', actualDuration, 'totalDuration:', totalDuration);
            
            timerState.duration = totalDuration;
            timerState.remainingTime = totalDuration;
            timerState.startTime = performance.now();
            timerState.roundStartTime = performance.now(); // –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞—É–Ω–¥–∞
            timerState.pausedDuration = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –ø–∞—É–∑
            timerState.isRunning = true;
            timerState.isPaused = false;
            timerState.carriedTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            
            // –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –æ—á–∏—â–∞–µ–º –µ–≥–æ –∏–∑ localStorage
            if (loadedCarriedTime > 0) {
                clearCarriedTime();
                console.log('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è:', loadedCarriedTime, '—Å–µ–∫—É–Ω–¥');
            }
            
            updateTimerDisplay();
            timerLoop();
        }

        function stopTimer() {
            timerState.isRunning = false;
            timerState.isPaused = false;
            if (timerState.animationFrameId) {
                cancelAnimationFrame(timerState.animationFrameId);
                timerState.animationFrameId = null;
            }
        }

        function pauseTimer() {
            if (timerState.isRunning && !timerState.isPaused) {
                timerState.isPaused = true;
                timerState.pauseStartTime = performance.now(); // –§–∏–∫—Å–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–∞—É–∑—ã
                if (timerState.animationFrameId) {
                    cancelAnimationFrame(timerState.animationFrameId);
                    timerState.animationFrameId = null;
                }
            }
        }

        function resumeTimer() {
            if (timerState.isRunning && timerState.isPaused) {
                timerState.isPaused = false;
                // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–∞—É–∑—ã –∫ –æ–±—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏ –ø–∞—É–∑
                if (timerState.pauseStartTime) {
                    timerState.pausedDuration += performance.now() - timerState.pauseStartTime;
                    timerState.pauseStartTime = null;
                }
                // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Å —É—á–µ—Ç–æ–º –ø–∞—É–∑—ã
                timerState.startTime = performance.now() - (timerState.duration - timerState.remainingTime);
                timerLoop();
            }
        }

        function resetTimer() {
            stopTimer();
            timerState = {
                isRunning: false,
                isPaused: false,
                startTime: null,
                duration: 60000,
                remainingTime: 60000,
                animationFrameId: null,
                carriedTime: 0,
                roundStartTime: null,
                pausedDuration: 0,
                pauseStartTime: null
            };
        }

        function timerLoop() {
            if (!timerState.isRunning || timerState.isPaused) {
                return;
            }

            const now = performance.now();
            const elapsed = now - timerState.startTime;
            timerState.remainingTime = Math.max(0, timerState.duration - elapsed);

            updateTimerDisplay();

            if (timerState.remainingTime <= 0) {
                // –í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ
                timerState.isRunning = false;
                // –ü—Ä–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è = 0
                const carriedTime = 0;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –≤ localStorage (–∫–ª–∏–µ–Ω—Ç—Å–∫–∞—è –ª–æ–≥–∏–∫–∞)
                saveCarriedTime(carriedTime);
                
                sendEvent('time_up', { carriedTime: carriedTime });
            } else {
                timerState.animationFrameId = requestAnimationFrame(timerLoop);
            }
        }

        function updateTimerDisplay() {
            const seconds = Math.ceil(timerState.remainingTime / 1000);
            document.getElementById('timer').textContent = seconds;
        }

        function showHandoffScreen(data) {
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            stopTimer();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–ª–µ–¥—É—é—â–µ–º –∏–≥—Ä–æ–∫–µ
            const nextPlayerName = document.getElementById('nextPlayerName');
            const nextPlayerTeam = document.getElementById('nextPlayerTeam');
            
            if (data.nextPlayer) {
                nextPlayerName.textContent = data.nextPlayer.name;
                
                // –ù–∞—Ö–æ–¥–∏–º –∫–æ–º–∞–Ω–¥—É –∏–≥—Ä–æ–∫–∞
                const playerTeam = gameState.teams.find(team => 
                    team.players && team.players.includes(data.nextPlayer.id)
                );
                if (playerTeam) {
                    nextPlayerTeam.textContent = playerTeam.name;
                } else {
                    nextPlayerTeam.textContent = '';
                }
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –ø–µ—Ä–µ–¥–∞—á–∏ —Ö–æ–¥–∞
            showScreen('handoffScreen');
        }

        function startNextTurn() {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞
            sendEvent('start_next_turn');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —ç–∫—Ä–∞–Ω—É –∏–≥—Ä—ã
            showScreen('gameScreen');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ö–æ–¥–∞ (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
            startTimer(gameSetup.roundDuration);
        }

        // –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        function validatePlayerCount() {
            const playerCountSelect = document.getElementById('playerCount');
            const playerCount = parseInt(playerCountSelect.value);
            
            if (playerCount < 4 || playerCount > 20) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 4 –¥–æ 20.');
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                playerCountSelect.value = '4';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ —Ç–∞–π–º–µ—Ä–∞
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && timerState.isRunning && !timerState.isPaused) {
                // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–Ω–æ–≤–∞ –≤–∏–¥–∏–º–∞, –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ç–∞–π–º–µ—Ä
                const now = performance.now();
                const elapsed = now - timerState.startTime;
                timerState.remainingTime = Math.max(0, timerState.duration - elapsed);
                updateTimerDisplay();
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–≥—Ä–æ–∫–æ–≤
            const playerCountSelect = document.getElementById('playerCount');
            if (playerCountSelect) {
                playerCountSelect.addEventListener('change', validatePlayerCount);
            }
        });
    </script>
</body>
</html>
