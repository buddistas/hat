<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Шляпа - Игра в слова</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        .setup-form {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255,255,255,0.9);
            color: #333;
            font-size: 16px;
        }

        .btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.3);
        }

        .game-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            text-align: center;
            min-height: 0; /* Позволяет flex-элементам сжиматься */
        }

        .game-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            min-height: 0;
        }

        .current-word {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255,255,255,0.2);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: keep-all; /* Не разрываем слова по слогам */
            white-space: normal; /* Разрешаем перенос строк */
            overflow-wrap: break-word; /* Переносим только при необходимости */
            width: 100%;
            text-align: center;
            line-height: 1.2; /* Улучшаем читаемость при переносе строк */
        }

        .timer {
            font-size: 2rem;
            font-weight: bold;
            margin: 20px 0;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-controls-top {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: flex-end;
        }

        .game-controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            max-width: 350px;
            flex-shrink: 0; /* Предотвращаем сжатие кнопок */
        }

        .game-controls .btn {
            flex: 1;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }

        .btn-small {
            padding: 8px 16px !important;
            font-size: 14px !important;
            margin: 0 !important;
            flex: none !important;
        }

        .btn-success {
            background: #4caf50;
        }

        .btn-success:hover {
            background: #45a049;
        }

        .btn-warning {
            background: #ff9800;
        }

        .btn-warning:hover {
            background: #f57c00;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .scores {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 15px;
        }

        .score-item {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            min-width: 100px;
        }

        .score-item h3 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .score-item .score {
            font-size: 2rem;
            font-weight: bold;
            color: #ffeb3b;
        }

        .round-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .player-info {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .words-counter {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 600;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 10px 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .words-counter:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-1px);
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .connection-status.connected {
            background: #4caf50;
            color: white;
        }

        .connection-status.disconnected {
            background: #f44336;
            color: white;
        }

        .results {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .results h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2rem;
        }

        .winner {
            text-align: center;
            margin: 20px 0;
            font-size: 1.5rem;
            color: #ffeb3b;
            font-weight: bold;
        }

        .team-item {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .teams-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .teams-container::-webkit-scrollbar {
            width: 6px;
        }

        .teams-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .teams-container::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .teams-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.5);
        }

        .team-item h3 {
            margin-bottom: 10px;
            color: #ffeb3b;
            font-size: 1.1rem;
        }

        .team-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .player-tag {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 14px;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .handoff-info {
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            text-align: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .next-player-info {
            margin: 30px 0;
        }

        .next-player-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .next-player-team {
            font-size: 1.3rem;
            opacity: 0.9;
            color: white;
        }

        /* Стили для экранов правил */
        .rules-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .rules-content {
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 40px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255,255,255,0.2);
            max-width: 500px;
            width: 100%;
            text-align: center;
            animation: rulesSlideIn 0.8s ease-out;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .rules-header {
            margin-bottom: 40px;
            animation: rulesHeaderFadeIn 1s ease-out 0.3s both;
        }

        .rules-title {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            background: linear-gradient(45deg, #ffeb3b, #ff9800);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .rules-subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            color: #ffeb3b;
            font-weight: 600;
        }

        .rules-body {
            margin-bottom: 40px;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            animation: ruleItemSlideIn 0.6s ease-out both;
            transition: all 0.3s ease;
        }

        .rule-item:nth-child(1) { animation-delay: 0.5s; }
        .rule-item:nth-child(2) { animation-delay: 0.7s; }
        .rule-item:nth-child(3) { animation-delay: 0.9s; }

        .rule-item:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .rule-icon {
            font-size: 2.5rem;
            margin-right: 20px;
            flex-shrink: 0;
            animation: ruleIconBounce 1s ease-out both;
        }

        .rule-item:nth-child(1) .rule-icon { animation-delay: 0.6s; }
        .rule-item:nth-child(2) .rule-icon { animation-delay: 0.8s; }
        .rule-item:nth-child(3) .rule-icon { animation-delay: 1s; }

        .rule-text {
            text-align: left;
            flex: 1;
        }

        .rule-text h3 {
            font-size: 1.2rem;
            margin-bottom: 8px;
            color: #ffeb3b;
            font-weight: 600;
        }

        .rule-text p {
            font-size: 1rem;
            line-height: 1.5;
            opacity: 0.9;
        }

        .rules-btn {
            background: linear-gradient(45deg, #4caf50, #45a049);
            font-size: 1.2rem;
            padding: 18px 40px;
            border-radius: 30px;
            animation: rulesBtnPulse 2s ease-in-out infinite;
            box-shadow: 0 10px 20px rgba(76,175,80,0.3);
            transition: all 0.3s ease;
        }

        .rules-btn:hover {
            background: linear-gradient(45deg, #45a049, #4caf50);
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(76,175,80,0.4);
        }

        .rules-btn:active {
            transform: translateY(-1px);
        }

        /* Анимации */
        @keyframes rulesSlideIn {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes rulesHeaderFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes ruleItemSlideIn {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes ruleIconBounce {
            0% {
                opacity: 0;
                transform: scale(0.3) rotate(-10deg);
            }
            50% {
                transform: scale(1.1) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        @keyframes rulesBtnPulse {
            0%, 100% {
                box-shadow: 0 10px 20px rgba(76,175,80,0.3);
            }
            50% {
                box-shadow: 0 15px 30px rgba(76,175,80,0.5);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .current-word {
                font-size: 2rem;
                padding: 15px;
                word-break: keep-all; /* Не разрываем слова по слогам на мобильных */
                line-height: 1.3; /* Немного больше межстрочный интервал на мобильных */
            }
            
            .game-controls {
                flex-direction: column;
                max-width: 100%;
            }

            .game-controls-top {
                flex-direction: column;
                gap: 8px;
            }

            .teams-container {
                max-height: 300px;
            }

            .player-tag {
                font-size: 12px;
                padding: 4px 8px;
            }

            .team-item {
                padding: 12px;
            }

            .team-item h3 {
                font-size: 1rem;
            }

            /* Адаптация экранов правил для мобильных */
            .rules-content {
                padding: 25px;
                margin: 10px;
            }

            .rules-title {
                font-size: 2.2rem;
            }

            .rules-subtitle {
                font-size: 1.1rem;
            }

            .rule-item {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }

            .rule-icon {
                margin-right: 0;
                margin-bottom: 10px;
                font-size: 2rem;
            }

            .rule-text {
                text-align: center;
            }

            .rule-text h3 {
                font-size: 1.1rem;
            }

            .rule-text p {
                font-size: 0.9rem;
            }

            .rules-btn {
                font-size: 1.1rem;
                padding: 15px 30px;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Подключение...</div>
    
    <div class="container">
        <div class="header">
            <h1>🎩 Шляпа</h1>
            <p>Игра в слова для компании</p>
        </div>

        <!-- Экран настройки игры -->
        <div class="screen active" id="setupScreen">
            <div class="setup-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Настройка игры</h2>
                
                <div class="form-group">
                    <label for="playerCount">Количество игроков:</label>
                    <select id="playerCount">
                        <option value="4">4 игрока</option>
                        <option value="5">5 игроков</option>
                        <option value="6">6 игроков</option>
                        <option value="7">7 игроков</option>
                        <option value="8">8 игроков</option>
                        <option value="9">9 игроков</option>
                        <option value="10">10 игроков</option>
                        <option value="11">11 игроков</option>
                        <option value="12">12 игроков</option>
                        <option value="13">13 игроков</option>
                        <option value="14">14 игроков</option>
                        <option value="15">15 игроков</option>
                        <option value="16">16 игроков</option>
                        <option value="17">17 игроков</option>
                        <option value="18">18 игроков</option>
                        <option value="19">19 игроков</option>
                        <option value="20">20 игроков</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="teamCount">Количество команд:</label>
                    <select id="teamCount">
                        <option value="2">2 команды</option>
                        <option value="3">3 команды</option>
                        <option value="4">4 команды</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="roundDuration">Длительность хода (секунды):</label>
                    <select id="roundDuration">
                        <option value="30" selected>30 секунд</option>
                        <option value="60">60 секунд</option>
                        <option value="90">90 секунд</option>
                    </select>
                </div>

                <button class="btn" onclick="setupTeams()">Настроить команды</button>
            </div>
        </div>

        <!-- Экран настройки команд -->
        <div class="screen" id="teamsScreen">
            <div class="setup-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Настройка команд</h2>
                
                <div class="form-group">
                    <label>Распределение игроков по командам:</label>
                    <div class="teams-container">
                        <div id="teamsList" style="margin-top: 15px;"></div>
                    </div>
                    <button class="btn btn-secondary" onclick="shuffleTeams()" style="margin-top: 15px;">Перемешать команды</button>
                </div>

                <button class="btn" onclick="setupWords()">Настроить слова</button>
            </div>
        </div>

        <!-- Экран настройки слов -->
        <div class="screen" id="wordsScreen">
            <div class="setup-form">
                <h2 style="text-align: center; margin-bottom: 30px;">Настройка слов</h2>
                
                <div class="form-group">
                    <label for="wordsCount">Количество слов в шляпе:</label>
                    <select id="wordsCount">
                        <option value="20">20 слов</option>
                        <option value="30">30 слов</option>
                        <option value="40">40 слов</option>
                        <option value="50">50 слов</option>
                        <option value="60">60 слов</option>
                        <option value="70">70 слов</option>
                        <option value="80">80 слов</option>
                        <option value="90">90 слов</option>
                        <option value="100" selected>100 слов</option>
                        <option value="120">120 слов</option>
                        <option value="140">140 слов</option>
                        <option value="160">160 слов</option>
                        <option value="180">180 слов</option>
                        <option value="200">200 слов</option>
                    </select>
                </div>

                <div class="form-group">
                    <p style="text-align: center; opacity: 0.8; font-size: 14px; margin-top: 10px;">
                        Слова будут выбраны случайным образом из игрового словаря
                    </p>
                </div>

                <button class="btn" onclick="startGame()">Начать игру</button>
            </div>
        </div>

        <!-- Экран игры -->
        <div class="screen" id="gameScreen">
            <div class="game-controls-top">
                <button class="btn btn-secondary btn-small" onclick="pauseGame()" id="pauseBtn">Пауза</button>
                <button class="btn btn-danger btn-small" onclick="endGame()">Завершить игру</button>
            </div>
            
            <div class="round-info" id="roundInfo" style="font-weight: bold; font-size: 1.2em; color: #2196F3;">Текущий раунд: 1 из 3</div>
            <div class="player-info" id="playerInfo">Ход игрока</div>
            <div class="words-counter" id="wordsCounter">Еще слов - 99</div>
            
            <div class="game-area">
                <div class="game-content">
                    <div class="timer" id="timer">30</div>
                    <div class="current-word" id="currentWord">Нажмите "Пропуск" для следующего слова</div>
                </div>
                
                <div class="game-controls">
                    <button class="btn btn-success" onclick="wordGuessed()">Верно</button>
                    <button class="btn btn-warning" onclick="wordPassed()">Пропуск</button>
                </div>
            </div>
        </div>

        <!-- Экран передачи хода -->
        <div class="screen" id="handoffScreen">
            <div class="game-area">
                <div class="handoff-info">
                    <h2 style="text-align: center; margin-bottom: 30px; color: #ffeb3b;">Передача хода</h2>
                    <div class="next-player-info">
                        <div class="next-player-name" id="nextPlayerName">Игрок</div>
                        <div class="next-player-team" id="nextPlayerTeam">Команда</div>
                    </div>
                    <div class="handoff-message">
                        <p style="text-align: center; font-size: 1.2rem; margin: 30px 0; opacity: 0.9;">
                            Готовы начать ход?
                        </p>
                    </div>
                    <button class="btn" onclick="startNextTurn()" id="startTurnBtn">Старт</button>
                </div>
            </div>
        </div>

        <!-- Экран счета между раундами -->
        <div class="screen" id="roundScoresScreen">
            <div class="results">
                <h2>Результаты раунда</h2>
                <div class="scores" id="roundScores"></div>
                
                <button class="btn" onclick="continueToNextRound()" id="continueBtn">Продолжить</button>
            </div>
        </div>

        <!-- Экран правил 1-го раунда -->
        <div class="screen" id="rulesScreen1">
            <div class="rules-container">
                <div class="rules-content">
                    <div class="rules-header">
                        <h1 class="rules-title">🎯 Раунд 1</h1>
                        <div class="rules-subtitle">Свободное объяснение</div>
                    </div>
                    
                    <div class="rules-body">
                        <div class="rule-item">
                            <div class="rule-icon">💬</div>
                            <div class="rule-text">
                                <h3>Объясняйте слова словами</h3>
                                <p>Используйте любые слова для объяснения, но не называйте само слово или однокоренные слова</p>
                            </div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-icon">🚫</div>
                            <div class="rule-text">
                                <h3>Запрещено</h3>
                                <p>Жесты, мимика, звуки, созвучия и однокоренные слова</p>
                            </div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-icon">⏱️</div>
                            <div class="rule-text">
                                <h3>Время</h3>
                                <p id="round1Time">У вас есть 30 секунд на объяснение слов</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn rules-btn" onclick="startFirstRound()">Ясно! Начать игру</button>
                </div>
            </div>
        </div>

        <!-- Экран правил 2-го раунда -->
        <div class="screen" id="rulesScreen2">
            <div class="rules-container">
                <div class="rules-content">
                    <div class="rules-header">
                        <h1 class="rules-title">🎭 Раунд 2</h1>
                        <div class="rules-subtitle">Жесты и мимика</div>
                    </div>
                    
                    <div class="rules-body">
                        <div class="rule-item">
                            <div class="rule-icon">🤲</div>
                            <div class="rule-text">
                                <h3>Только жесты и мимика</h3>
                                <p>Объясняйте слова жестами, мимикой и движениями тела</p>
                            </div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-icon">🚫</div>
                            <div class="rule-text">
                                <h3>Слова запрещены!</h3>
                                <p>Никаких слов, звуков или текстовых подсказок</p>
                            </div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-icon">⏱️</div>
                            <div class="rule-text">
                                <h3>Время</h3>
                                <p id="round1Time">У вас есть 30 секунд на объяснение слов</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn rules-btn" onclick="startSecondRound()">Ясно! Начать раунд</button>
                </div>
            </div>
        </div>

        <!-- Экран правил 3-го раунда -->
        <div class="screen" id="rulesScreen3">
            <div class="rules-container">
                <div class="rules-content">
                    <div class="rules-header">
                        <h1 class="rules-title">🎯 Раунд 3</h1>
                        <div class="rules-subtitle">Одно слово</div>
                    </div>
                    
                    <div class="rules-body">
                        <div class="rule-item">
                            <div class="rule-icon">📝</div>
                            <div class="rule-text">
                                <h3>Только одно слово</h3>
                                <p>Объясняйте каждое слово только одним словом-ассоциацией</p>
                            </div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-icon">🎯</div>
                            <div class="rule-text">
                                <h3>Максимально точно</h3>
                                <p>Выбирайте самое точное и понятное слово для объяснения</p>
                            </div>
                        </div>
                        
                        <div class="rule-item">
                            <div class="rule-icon">⏱️</div>
                            <div class="rule-text">
                                <h3>Время</h3>
                                <p id="round1Time">У вас есть 30 секунд на объяснение слов</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn rules-btn" onclick="startThirdRound()">Ясно! Начать раунд</button>
                </div>
            </div>
        </div>

        <!-- Экран результатов -->
        <div class="screen" id="resultsScreen">
            <div class="results">
                <h2>Результаты игры</h2>
                <div class="winner" id="winner"></div>
                <div class="scores" id="finalScores"></div>
                <button class="btn" onclick="newGame()">Новая игра</button>
            </div>
        </div>
    </div>

    <script>
        let ws;
        let gameState = {};
        let gameSetup = {
            players: [],
            teams: [],
            roundDuration: 30,
            wordsCount: 100
        };

        // Клиентский таймер с использованием performance.now()
        let timerState = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            duration: 30000, // 30 секунд в миллисекундах
            remainingTime: 30000,
            animationFrameId: null,
            carriedTime: 0, // Перенесенное время между раундами
            roundStartTime: null, // Время начала раунда для корректного вычисления перенесенного времени
            pausedDuration: 0, // Общее время пауз в раунде
            pauseStartTime: null // Время начала текущей паузы
        };

        // Подключение к WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket подключен');
                updateConnectionStatus(true);
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                console.log('Получено сообщение:', message);
                console.log('Тип сообщения:', message.type);
                
                if (message.type === 'game_state') {
                    gameState = message.data;
                    console.log('Получен game_state с playerCarriedTime:', gameState.playerCarriedTime);
                    updateGameDisplay();
                    
                    // Если мы на экране игры и таймер не запущен, запускаем его с учетом carriedTime
                    if (document.getElementById('gameScreen').classList.contains('active') && !timerState.isRunning) {
                        const currentPlayerCarriedTime = gameState.playerCarriedTime && gameState.currentPlayer 
                            ? (gameState.playerCarriedTime[gameState.currentPlayer.id] || 0)
                            : 0;
                        
                        console.log('Запускаем таймер после получения game_state:');
                        console.log('- currentPlayer:', gameState.currentPlayer);
                        console.log('- currentPlayerCarriedTime:', currentPlayerCarriedTime);
                        
                        startTimer(gameSetup.roundDuration, currentPlayerCarriedTime);
                    }
                } else if (message.type === 'round_completed') {
                    console.log('Получено событие round_completed:', message.data);
                    // НЕ обновляем currentRound здесь - правильное значение придет в следующем game_state
                    // message.data.currentRound содержит номер завершенного раунда (1, 2, 3)
                    gameState.scores = message.data.scores;
                    
                    // Если таймер еще работает, значит раунд завершился по исчерпанию слов
                    // В этом случае нужно правильно вычислить перенесенное время
                    if (timerState.isRunning) {
                        endRoundByWordsExhausted();
                    }
                    // Если таймер уже остановлен, перенесенное время уже вычислено
                    
                    // Определяем, какой экран показать после завершения раунда
                    // message.data.currentRound содержит номер завершенного раунда (1, 2, 3)
                    const completedRound = message.data.currentRound;
                    
                    if (completedRound === 1) {
                        // Завершился первый раунд - показываем результаты раунда
                        showRoundScores();
                        showScreen('roundScoresScreen');
                    } else if (completedRound === 2) {
                        // Завершился второй раунд - показываем экран правил 3-го раунда
                        showScreen('rulesScreen3');
                    } else if (completedRound === 3) {
                        // Завершился третий раунд - игра окончена, показываем результаты
                        showResults();
                        showScreen('resultsScreen');
                    }
                } else if (message.type === 'handoff_screen') {
                    console.log('Получено событие handoff_screen:', message.data);
                    showHandoffScreen(message.data);
                } else if (message.type === 'error') {
                    alert('Ошибка: ' + message.message);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket отключен');
                updateConnectionStatus(false);
                // Попытка переподключения через 3 секунды
                setTimeout(connectWebSocket, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket ошибка:', error);
                updateConnectionStatus(false);
            };
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'Подключено';
                status.className = 'connection-status connected';
            } else {
                status.textContent = 'Отключено';
                status.className = 'connection-status disconnected';
            }
        }

        function sendEvent(type, data = {}) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, data }));
            } else {
                console.error('WebSocket не подключен');
            }
        }

        function setupTeams() {
            const playerCount = parseInt(document.getElementById('playerCount').value);
            const teamCount = parseInt(document.getElementById('teamCount').value);
            const roundDuration = parseInt(document.getElementById('roundDuration').value);
            
            // Валидация количества игроков
            if (playerCount < 4 || playerCount > 20) {
                alert('Количество игроков должно быть от 4 до 20.');
                return;
            }
            
            // Создание игроков и команд
            const players = [];
            const teams = [];
            
            for (let i = 1; i <= playerCount; i++) {
                players.push({
                    id: `player_${i}`,
                    name: `Игрок ${i}`
                });
            }
            
            for (let i = 1; i <= teamCount; i++) {
                teams.push({
                    id: `team_${i}`,
                    name: `Команда ${i}`,
                    players: []
                });
            }
            
            // Распределение игроков по командам
            players.forEach((player, index) => {
                const teamIndex = index % teamCount;
                teams[teamIndex].players.push(player.id);
            });
            
            // Сохранение настроек
            gameSetup.players = players;
            gameSetup.teams = teams;
            gameSetup.roundDuration = roundDuration;
            
            // Отображение команд
            displayTeams();
            showScreen('teamsScreen');
        }

        function displayTeams() {
            const teamsList = document.getElementById('teamsList');
            teamsList.innerHTML = '';
            
            gameSetup.teams.forEach(team => {
                const teamDiv = document.createElement('div');
                teamDiv.className = 'team-item';
                
                const playersHtml = team.players.map(playerId => {
                    const player = gameSetup.players.find(p => p.id === playerId);
                    return `<span class="player-tag">${player.name}</span>`;
                }).join('');
                
                teamDiv.innerHTML = `
                    <h3>${team.name}</h3>
                    <div class="team-players">${playersHtml}</div>
                `;
                
                teamsList.appendChild(teamDiv);
            });
        }

        function shuffleTeams() {
            const playerCount = gameSetup.players.length;
            const teamCount = gameSetup.teams.length;
            
            // Очистка команд
            gameSetup.teams.forEach(team => {
                team.players = [];
            });
            
            // Случайное распределение игроков
            const shuffledPlayers = [...gameSetup.players].sort(() => Math.random() - 0.5);
            
            shuffledPlayers.forEach((player, index) => {
                const teamIndex = index % teamCount;
                gameSetup.teams[teamIndex].players.push(player.id);
            });
            
            displayTeams();
        }

        function setupWords() {
            showScreen('wordsScreen');
        }

        function updateRulesTimeText() {
            const timeElements = document.querySelectorAll('#round1Time');
            timeElements.forEach(element => {
                element.textContent = `У вас есть ${gameSetup.roundDuration} секунд на объяснение слов`;
            });
        }

        function startGame() {
            const wordsCount = parseInt(document.getElementById('wordsCount').value);
            gameSetup.wordsCount = wordsCount;
            
            // Очищаем перенесенное время при начале новой игры
            clearCarriedTime();
            
            // Обновляем текст времени в правилах
            updateRulesTimeText();
            
            sendEvent('start_game', {
                players: gameSetup.players,
                teams: gameSetup.teams,
                roundDuration: gameSetup.roundDuration,
                wordsCount: gameSetup.wordsCount
            });
            
            // Показываем экран правил первого раунда вместо прямого перехода к игре
            showScreen('rulesScreen1');
        }

        // Функции для экранов правил
        function startFirstRound() {
            showScreen('gameScreen');
            startTimer(gameSetup.roundDuration);
        }

        function startSecondRound() {
            // Переходим к следующему раунду
            sendEvent('continue_round');
            showScreen('gameScreen');
            console.log('startSecondRound - ждем обновления game_state для запуска таймера');
            // Таймер будет запущен после получения обновленного game_state
        }

        function startThirdRound() {
            // Переходим к следующему раунду
            sendEvent('continue_round');
            showScreen('gameScreen');
            console.log('startThirdRound - ждем обновления game_state для запуска таймера');
            // Таймер будет запущен после получения обновленного game_state
        }


        function wordGuessed() {
            const currentTeam = getCurrentTeam();
            if (currentTeam) {
                sendEvent('word_guessed', { teamId: currentTeam.id });
            }
        }

        function wordPassed() {
            const currentTeam = getCurrentTeam();
            if (currentTeam) {
                sendEvent('word_passed', { teamId: currentTeam.id });
            }
        }

        function pauseGame() {
            const pauseBtn = document.getElementById('pauseBtn');
            if (timerState.isPaused) {
                sendEvent('resume_game');
                pauseBtn.textContent = 'Пауза';
                resumeTimer();
            } else {
                sendEvent('pause_game');
                pauseBtn.textContent = 'Продолжить';
                pauseTimer();
            }
        }

        function endGame() {
            if (confirm('Вы уверены, что хотите завершить игру?')) {
                showScreen('resultsScreen');
                showResults();
            }
        }

        function newGame() {
            showScreen('setupScreen');
            stopTimer();
            // Сброс настроек игры
            gameSetup = {
                players: [],
                teams: [],
                roundDuration: 30,
                wordsCount: 100
            };
            // Сброс состояния таймера
            resetTimer();
        }

        function getCurrentTeam() {
            if (!gameState.teams || !gameState.currentPlayer) return null;
            
            for (const team of gameState.teams) {
                if (team.players && team.players.includes(gameState.currentPlayer.id)) {
                    return team;
                }
            }
            return null;
        }

        function updateGameDisplay() {
            // Обновление информации о раунде
            const roundInfo = document.getElementById('roundInfo');
            if (gameState.currentRound !== undefined) {
                console.log('Обновление отображения раунда:', gameState.currentRound, 'отображается как:', gameState.currentRound + 1);
                roundInfo.textContent = `Текущий раунд: ${gameState.currentRound + 1} из 3`;
            }
            
            // Обновление информации об игроке
            const playerInfo = document.getElementById('playerInfo');
            if (gameState.currentPlayer) {
                playerInfo.textContent = `Ход: ${gameState.currentPlayer.name}`;
            }
            
            // Обновление количества оставшихся слов
            const wordsCounter = document.getElementById('wordsCounter');
            if (gameState.availableWords !== undefined) {
                // Отнимаем единицу, так как текущее слово уже показано
                const wordsLeft = Math.max(0, gameState.availableWords.length - 1);
                wordsCounter.textContent = `Еще слов - ${wordsLeft}`;
                
                // Меняем цвет в зависимости от количества слов
                if (wordsLeft <= 10) {
                    wordsCounter.style.color = '#ff6b6b'; // Красный когда мало слов
                } else if (wordsLeft <= 25) {
                    wordsCounter.style.color = '#ff9800'; // Оранжевый когда среднее количество
                } else {
                    wordsCounter.style.color = '#ffeb3b'; // Желтый когда много слов
                }
            }
            
            // Обновление текущего слова
            const currentWord = document.getElementById('currentWord');
            if (gameState.currentWord) {
                currentWord.textContent = gameState.currentWord;
            } else {
                currentWord.textContent = 'Загрузка...';
            }
        }

        function updateScores() {
            const scoresContainer = document.getElementById('scores');
            scoresContainer.innerHTML = '';
            
            if (gameState.teams && gameState.scores) {
                gameState.teams.forEach(team => {
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'score-item';
                    scoreDiv.innerHTML = `
                        <h3>${team.name}</h3>
                        <div class="score">${gameState.scores[team.id] || 0}</div>
                    `;
                    scoresContainer.appendChild(scoreDiv);
                });
            }
        }

        function showRoundScores() {
            const roundScores = document.getElementById('roundScores');
            
            // Показываем результаты команд
            roundScores.innerHTML = '';
            if (gameState.teams && gameState.scores) {
                gameState.teams.forEach(team => {
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'score-item';
                    scoreDiv.innerHTML = `
                        <h3>${team.name}</h3>
                        <div class="score">${gameState.scores[team.id] || 0}</div>
                    `;
                    roundScores.appendChild(scoreDiv);
                });
            }
            
            // Показываем перенесенное время для текущего игрока
            const currentPlayerCarriedTime = gameState.playerCarriedTime && gameState.currentPlayer 
                ? (gameState.playerCarriedTime[gameState.currentPlayer.id] || 0)
                : 0;
            
            if (currentPlayerCarriedTime > 0) {
                const timeInfo = document.createElement('div');
                timeInfo.className = 'score-item';
                timeInfo.style.marginTop = '20px';
                timeInfo.innerHTML = `
                    <h3>Перенесено времени</h3>
                    <div class="score">${currentPlayerCarriedTime} сек</div>
                `;
                roundScores.appendChild(timeInfo);
            }
        }

        function continueToNextRound() {
            const nextRound = gameState.currentRound + 1;
            
            if (nextRound > 3) {
                // Игра завершена, показываем финальные результаты
                showResults();
                showScreen('resultsScreen');
            } else {
                // Переходим к следующему раунду
                sendEvent('continue_round');
                showScreen('gameScreen');
                
                console.log('continueToNextRound - ждем обновления game_state для запуска таймера');
                // Таймер будет запущен после получения обновленного game_state
            }
        }

        function showResults() {
            const winner = document.getElementById('winner');
            const finalScores = document.getElementById('finalScores');
            
            if (gameState.teams && gameState.scores) {
                let maxScore = -Infinity;
                let winnerTeam = null;
                
                gameState.teams.forEach(team => {
                    const score = gameState.scores[team.id] || 0;
                    if (score > maxScore) {
                        maxScore = score;
                        winnerTeam = team;
                    }
                });
                
                if (winnerTeam) {
                    winner.textContent = `🏆 Победила ${winnerTeam.name}!`;
                }
                
                // Показ финальных счетов
                finalScores.innerHTML = '';
                gameState.teams.forEach(team => {
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'score-item';
                    scoreDiv.innerHTML = `
                        <h3>${team.name}</h3>
                        <div class="score">${gameState.scores[team.id] || 0}</div>
                    `;
                    finalScores.appendChild(scoreDiv);
                });
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // Функции для работы с переносом времени в localStorage
        function saveCarriedTime(timeLeft) {
            if (timeLeft > 0) {
                localStorage.setItem('hatGame_carriedTime', timeLeft.toString());
                console.log('Сохранено перенесенное время:', timeLeft, 'секунд');
            } else {
                localStorage.removeItem('hatGame_carriedTime');
                console.log('Перенесенное время очищено');
            }
        }

        function loadCarriedTime() {
            const saved = localStorage.getItem('hatGame_carriedTime');
            const carriedTime = saved ? parseFloat(saved) : 0;
            console.log('Загружено перенесенное время:', carriedTime, 'секунд');
            return carriedTime;
        }

        function clearCarriedTime() {
            localStorage.removeItem('hatGame_carriedTime');
            console.log('Перенесенное время очищено');
        }

        // Функция для корректного вычисления перенесенного времени
        function calculateCarriedTime() {
            // Используем уже вычисленное оставшееся время из таймера
            // timerState.remainingTime уже учитывает паузы и корректно вычислено
            const carriedTime = Math.max(0, timerState.remainingTime);
            
            console.log('calculateCarriedTime:', {
                remainingTime: Math.round(timerState.remainingTime / 1000) + 's',
                duration: Math.round(timerState.duration / 1000) + 's',
                carriedTime: Math.round(carriedTime / 1000) + 's',
                isRunning: timerState.isRunning,
                isPaused: timerState.isPaused
            });

            return Math.ceil(carriedTime / 1000); // Возвращаем в секундах
        }

        // Функция для завершения раунда по исчерпанию слов
        function endRoundByWordsExhausted() {
            console.log('Раунд завершен по исчерпанию слов');
            
            // Останавливаем таймер
            stopTimer();
            
            // Вычисляем перенесенное время на основе оставшегося времени
            const carriedTime = calculateCarriedTime();
            
            // Сохраняем перенесенное время в localStorage
            saveCarriedTime(carriedTime);
            
            // Отправляем информацию о перенесенном времени на сервер
            if (carriedTime > 0) {
                sendEvent('round_completed_carried_time', { carriedTime: carriedTime });
            }
            
            console.log('Перенесенное время при завершении раунда:', carriedTime, 'секунд');
        }

        // Новые функции для работы с таймером
        function startTimer(durationSeconds, carriedTimeSeconds = 0) {
            stopTimer();
            
            console.log('startTimer вызван с параметрами:', { durationSeconds, carriedTimeSeconds });
            
            // Загружаем перенесенное время из localStorage, если не передано явно
            const loadedCarriedTime = carriedTimeSeconds > 0 ? carriedTimeSeconds : loadCarriedTime();
            
            // Если есть перенесенное время, используем только его, иначе стандартное время
            const actualDuration = loadedCarriedTime > 0 ? loadedCarriedTime : durationSeconds;
            const totalDuration = actualDuration * 1000;
            
            console.log('startTimer - loadedCarriedTime:', loadedCarriedTime, 'actualDuration:', actualDuration, 'totalDuration:', totalDuration);
            
            timerState.duration = totalDuration;
            timerState.remainingTime = totalDuration;
            timerState.startTime = performance.now();
            timerState.roundStartTime = performance.now(); // Фиксируем время начала раунда
            timerState.pausedDuration = 0; // Сбрасываем время пауз
            timerState.isRunning = true;
            timerState.isPaused = false;
            timerState.carriedTime = 0; // Сбрасываем перенесенное время после использования
            
            // Если использовали перенесенное время, очищаем его из localStorage
            if (loadedCarriedTime > 0) {
                clearCarriedTime();
                console.log('Использовано перенесенное время:', loadedCarriedTime, 'секунд');
            }
            
            updateTimerDisplay();
            timerLoop();
        }

        function stopTimer() {
            timerState.isRunning = false;
            timerState.isPaused = false;
            if (timerState.animationFrameId) {
                cancelAnimationFrame(timerState.animationFrameId);
                timerState.animationFrameId = null;
            }
        }

        function pauseTimer() {
            if (timerState.isRunning && !timerState.isPaused) {
                timerState.isPaused = true;
                timerState.pauseStartTime = performance.now(); // Фиксируем время начала паузы
                if (timerState.animationFrameId) {
                    cancelAnimationFrame(timerState.animationFrameId);
                    timerState.animationFrameId = null;
                }
            }
        }

        function resumeTimer() {
            if (timerState.isRunning && timerState.isPaused) {
                timerState.isPaused = false;
                // Добавляем время паузы к общему времени пауз
                if (timerState.pauseStartTime) {
                    timerState.pausedDuration += performance.now() - timerState.pauseStartTime;
                    timerState.pauseStartTime = null;
                }
                // Корректируем время начала с учетом паузы
                timerState.startTime = performance.now() - (timerState.duration - timerState.remainingTime);
                timerLoop();
            }
        }

        function resetTimer() {
            stopTimer();
            timerState = {
                isRunning: false,
                isPaused: false,
                startTime: null,
                duration: 30000,
                remainingTime: 30000,
                animationFrameId: null,
                carriedTime: 0,
                roundStartTime: null,
                pausedDuration: 0,
                pauseStartTime: null
            };
        }

        function timerLoop() {
            if (!timerState.isRunning || timerState.isPaused) {
                return;
            }

            const now = performance.now();
            const elapsed = now - timerState.startTime;
            timerState.remainingTime = Math.max(0, timerState.duration - elapsed);

            updateTimerDisplay();

            if (timerState.remainingTime <= 0) {
                // Время истекло
                timerState.isRunning = false;
                // При истечении времени перенесенное время = 0
                const carriedTime = 0;
                
                // Сохраняем перенесенное время в localStorage (клиентская логика)
                saveCarriedTime(carriedTime);
                
                sendEvent('time_up', { carriedTime: carriedTime });
            } else {
                timerState.animationFrameId = requestAnimationFrame(timerLoop);
            }
        }

        function updateTimerDisplay() {
            const seconds = Math.ceil(timerState.remainingTime / 1000);
            document.getElementById('timer').textContent = seconds;
        }

        function showHandoffScreen(data) {
            // Останавливаем таймер
            stopTimer();
            
            // Обновляем информацию о следующем игроке
            const nextPlayerName = document.getElementById('nextPlayerName');
            const nextPlayerTeam = document.getElementById('nextPlayerTeam');
            
            if (data.nextPlayer) {
                nextPlayerName.textContent = data.nextPlayer.name;
                
                // Находим команду игрока
                const playerTeam = gameState.teams.find(team => 
                    team.players && team.players.includes(data.nextPlayer.id)
                );
                if (playerTeam) {
                    nextPlayerTeam.textContent = playerTeam.name;
                } else {
                    nextPlayerTeam.textContent = '';
                }
            }
            
            // Показываем экран передачи хода
            showScreen('handoffScreen');
        }

        function startNextTurn() {
            // Отправляем событие о начале следующего хода
            sendEvent('start_next_turn');
            
            // Возвращаемся к экрану игры
            showScreen('gameScreen');
            
            // Запускаем таймер для нового хода (с автоматической загрузкой перенесенного времени)
            startTimer(gameSetup.roundDuration);
        }

        // Валидация количества игроков при изменении
        function validatePlayerCount() {
            const playerCountSelect = document.getElementById('playerCount');
            const playerCount = parseInt(playerCountSelect.value);
            
            if (playerCount < 4 || playerCount > 20) {
                alert('Количество игроков должно быть от 4 до 20.');
                // Устанавливаем значение по умолчанию
                playerCountSelect.value = '4';
            }
        }

        // Обработка изменения видимости страницы для корректировки таймера
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && timerState.isRunning && !timerState.isPaused) {
                // Страница снова видима, корректируем таймер
                const now = performance.now();
                const elapsed = now - timerState.startTime;
                timerState.remainingTime = Math.max(0, timerState.duration - elapsed);
                updateTimerDisplay();
            }
        });

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            
            // Добавляем валидацию при изменении количества игроков
            const playerCountSelect = document.getElementById('playerCount');
            if (playerCountSelect) {
                playerCountSelect.addEventListener('change', validatePlayerCount);
            }
        });
    </script>
</body>
</html>
