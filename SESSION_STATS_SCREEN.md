# Экран статистики игровой сессии

## Обзор

Добавлен новый экран статистики игровой сессии, который отображает детальную информацию о прошедшей партии. Экран доступен через навигацию в результатах игры.

**Важно**: Статистика игровой сессии собирается **локально в браузере** и не зависит от сервера.

## Функциональность

### Навигация
- Экран интегрирован в существующую навигацию результатов
- Доступен через кнопку "Статистика" на экранах результатов команд и игроков
- Три экрана: Команды → Игроки → Статистика

### Отображаемые данные

#### 1. Время игры
- **Общее время партии** - общая продолжительность всех раундов
- **Время по раундам** - продолжительность каждого раунда отдельно
- Формат отображения: минуты и секунды (например, "5м 30с")

#### 2. Интересные факты
- **Самое часто пропускаемое слово** - слово, которое игроки пропускали чаще всего
- **Самое сложное слово** - слово, на которое потратили больше всего времени
- Показывается количество пропусков и время соответственно

#### 3. Статистика по словам
- **Всего слов в игре** - общее количество слов, которые были в игре
- **Угадано слов** - количество успешно угаданных слов
- **Пропущено слов** - количество пропущенных слов
- **Процент угаданных** - процент успешно угаданных слов от общего количества

## Техническая реализация

### Frontend (Локальная система)
- **HTML**: Новый экран `sessionStatsScreen` с структурированным отображением данных
- **CSS**: Адаптивные стили с поддержкой мобильных устройств
- **JavaScript**: Локальная система сбора и отображения статистики

### Локальная система сбора статистики
- **Хранение**: Данные хранятся в переменной `sessionStats` в браузере
- **Сбор данных**: Автоматический сбор во время игры через игровые события
- **Независимость**: Полностью автономная система, не требует сервера

### Структура данных (локальная)

```javascript
let sessionStats = {
  gameId: string,
  startedAt: number,
  endedAt: number,
  duration: {
    roundDurations: { 0: number, 1: number, 2: number },
    totalGameDuration: number
  },
  facts: {
    mostPassedWord: { word: string, count: number },
    hardestWord: { word: string, totalTimeSeconds: number }
  },
  wordTracking: {
    passedWords: { [word: string]: number },
    wordDisplayTime: { [word: string]: number }
  },
  // Временные переменные для отслеживания
  _currentWord: string | null,
  _wordShownAt: number | null,
  _roundStartTime: number | null,
  _gameStartTime: number
}
```

## Система сбора данных

### Автоматический сбор во время игры
Статистика собирается автоматически через следующие события:

- **`initSessionStats()`** - инициализация при начале игры
- **`onWordShown(word)`** - фиксация времени показа слова
- **`onWordGuessed()`** - обновление времени показа при угадывании
- **`onWordPassed()`** - увеличение счетчика пропусков
- **`onRoundStarted(round)`** - начало отсчета времени раунда
- **`onRoundEnded(round)`** - фиксация продолжительности раунда
- **`onGameEnded()`** - расчет фактов и общей статистики

### Учет последнего слова в раунде

- Добавлена функция `finalizeCurrentWordDisplay()` — аккумулирует время показа для текущего слова, если оно было на экране в момент завершения хода/раунда/игры.
- Финализатор вызывается во всех путях завершения:
  - в `onRoundEnded(...)` — перед расчетом продолжительности раунда;
  - в `endRoundByWordsExhausted()` — до остановки таймера;
  - в `timerLoop()` при переходе оставшегося времени к нулю;
  - в `onGameEnded()` — до итоговых расчетов и пересчета фактов.

### Актуализация «Интересных фактов»

- Перед показом экрана статистики выполняется `calculateSessionFacts()` в `loadSessionStats()`,
  чтобы «Самое сложное слово» отображалось корректно даже при открытии экрана до `onGameEnded()`.

### Отображение времени

- «Общее время» отображается как сумма длительностей раундов, даже если игра ещё не завершена: используется
  `r0 + r1 + r2`, если `totalGameDuration` ещё не вычислен.

### Интеграция с игровыми событиями
- **Показ слов**: `updateGameDisplay()` → `onWordShown()`
- **Угадывание**: `wordGuessed()` → `onWordGuessed()`
- **Пропуск**: `wordPassed()` → `onWordPassed()`
- **Начало раундов**: `startFirstRound()`, `startSecondRound()`, `startThirdRound()` → `onRoundStarted()`
- **Завершение раундов**: WebSocket `round_completed` → `onRoundEnded()`
- **Завершение игры**: WebSocket `game_ended` → `onGameEnded()`

## Использование

1. Завершите игру (пройдите все 3 раунда)
2. На экране результатов нажмите кнопку "Статистика"
3. Просмотрите детальную статистику сессии
4. Используйте навигацию для переключения между экранами

## Адаптивность

- **Desktop**: Полная сетка с 4 колонками для времени и статистики
- **Tablet**: Адаптивная сетка с уменьшенными размерами
- **Mobile**: 2-колоночная сетка с вертикальным расположением фактов

## Обработка ошибок

- Данные собираются локально, поэтому ошибки загрузки исключены
- При отсутствии данных отображаются заглушки "—"
- Логирование всех событий в консоль браузера для отладки

## Интеграция

Экран полностью интегрирован в существующую архитектуру:
- **Независимость от сервера**: Работает полностью локально
- **Совместимость**: Интегрирован с текущей системой навигации
- **Стили**: Использует существующие CSS компоненты
- **События**: Подключен к игровым событиям через WebSocket
